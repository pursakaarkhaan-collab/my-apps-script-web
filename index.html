<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>HadirQ</title>
    <meta name="theme-color" content="#064e3b">
    <script src="https://unpkg.com/html5-qrcode"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --font-main: 'Inter', system-ui, -apple-system, sans-serif;
            /* ... existing vars ... */
            --primary: #10b981;
            --primary-light: #34d399;
            --primary-dark: #059669;
            --bg: #f0fdf4;
            --bg-secondary: #dcfce7;
            --card: rgba(255, 255, 255, 0.95);
            --text: #064e3b;
            --text-secondary: #6b7280;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --orange: #fb923c;
            --glass-bg: rgba(255, 255, 255, 0.85);
            --glass-border: rgba(16, 185, 129, 0.1);
            --glass-highlight: rgba(255, 255, 255, 0.95);
            --shadow-soft: 0 4px 20px rgba(0, 0, 0, 0.08);
            --shadow-card: 0 2px 12px rgba(0, 0, 0, 0.06);
            --shadow-glow: 0 0 20px rgba(16, 185, 129, 0.1);
            --radius-xl: 24px;
            --radius-lg: 16px;
        }

        /* Dark Mode Variables */
        [data-theme="dark"] {
            --bg: #0f172a;
            --bg-secondary: #1e293b;
            --card: rgba(30, 41, 59, 0.8);
            --text: #f1f5f9;
            --text-secondary: #94a3b8;
            --glass-bg: rgba(30, 41, 59, 0.6);
            --glass-border: rgba(148, 163, 184, 0.1);
            --glass-highlight: rgba(148, 163, 184, 0.05);
            --shadow-soft: 0 8px 32px rgba(0, 0, 0, 0.4);
            --shadow-card: 0 4px 16px rgba(0, 0, 0, 0.3);
            --shadow-glow: 0 0 30px rgba(16, 185, 129, 0.15);
        }

        /* Light mode (default - clean and elegant) */
        [data-theme="light"] {
            --bg: #dddbd9;
            --bg-secondary: #f1f5f9;
            --text: #0f172a;
            --text-secondary: #64748b;
            --glass-bg: rgba(255, 255, 255, 0.9);
            --card: rgba(255, 255, 255, 0.95);
            --glass-border: rgba(148, 163, 184, 0.15);
            --glass-highlight: rgba(255, 255, 255, 1);
            --shadow-soft: 0 4px 20px rgba(0, 0, 0, 0.06);
            --shadow-card: 0 2px 12px rgba(0, 0, 0, 0.04);
        }

        [data-theme="dark"] input,
        [data-theme="dark"] select,
        [data-theme="dark"] textarea {
            background: rgba(255, 255, 255, 0.05);
            border-color: rgba(255, 255, 255, 0.1);
            color: var(--text);
        }

        [data-theme="dark"] table th {
            background: rgba(16, 185, 129, 0.15);
        }

        [data-theme="dark"] tr:nth-child(even) {
            background: rgba(255, 255, 255, 0.02);
        }

        [data-theme="dark"] .activity-item {
            border-bottom-color: rgba(255, 255, 255, 0.05);
        }

        [data-theme="dark"] .badge-success {
            background: rgba(16, 185, 129, 0.2);
            color: #34d399;
        }

        [data-theme="dark"] .badge-warning {
            background: rgba(245, 158, 11, 0.2);
            color: #fbbf24;
        }

        [data-theme="dark"] .badge-danger {
            background: rgba(239, 68, 68, 0.2);
            color: #f87171;
        }

        [data-theme="dark"] .badge-info {
            background: rgba(16, 185, 129, 0.15);
            color: #6ee7b7;
        }

        [data-theme="dark"] .alert-success {
            background: rgba(16, 185, 129, 0.15);
            color: #34d399;
        }

        [data-theme="dark"] .alert-error {
            background: rgba(239, 68, 68, 0.15);
            color: #f87171;
        }

        [data-theme="dark"] .alert-warning {
            background: rgba(245, 158, 11, 0.15);
            color: #fbbf24;
        }

        [data-theme="dark"] button.sec {
            background: rgba(255, 255, 255, 0.08);
            color: var(--text);
            border-color: rgba(255, 255, 255, 0.15);
        }

        [data-theme="dark"] .modal-content {
            background: var(--bg-secondary);
            color: var(--text);
        }

        [data-theme="dark"] .logo-preview {
            background: rgba(255, 255, 255, 0.05);
            border-color: rgba(255, 255, 255, 0.1);
        }

        [data-theme="dark"] .selected-student {
            background: rgba(16, 185, 129, 0.3);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0
        }

        html {
            background: var(--bg);
            height: 100%;
            overflow-y: scroll;
            margin: 0;
            padding: 0;
            overscroll-behavior-y: none;
            /* Prevent elastic scrolling reveal */
        }

        body {
            font-family: var(--font-main);
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 0;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            min-height: 100dvh;
            padding-bottom: 0;
            overflow-x: hidden;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        /* Glass Background Decoration */
        .glass-bg-container {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: -1;
            overflow: hidden;
            background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 50%, #f0fdf4 100%);
        }

        [data-theme="dark"] .glass-bg-container {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #0f172a 100%);
        }

        [data-theme="light"] .glass-bg-container {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 50%, #f8fafc 100%);
        }

        .blob {
            position: absolute;
            border-radius: 50%;
            filter: blur(80px);
            opacity: 0.15;
            z-index: -1;
            animation: blobFloat 30s infinite alternate ease-in-out;
        }

        [data-theme="dark"] .blob {
            opacity: 0.1;
            filter: blur(100px);
        }

        [data-theme="light"] .blob {
            opacity: 0.12;
            filter: blur(90px);
        }

        .blob-1 {
            width: 60vmax;
            height: 60vmax;
            background: radial-gradient(circle, #10b981 0%, transparent 70%);
            top: -15%;
            left: -10%;
        }

        .blob-2 {
            width: 50vmax;
            height: 50vmax;
            background: radial-gradient(circle, #34d399 0%, transparent 70%);
            bottom: -10%;
            right: -10%;
            animation-duration: 40s;
        }

        .blob-3 {
            width: 45vmax;
            height: 45vmax;
            background: radial-gradient(circle, #6ee7b7 0%, transparent 70%);
            top: 35%;
            left: 50%;
            animation-duration: 25s;
        }

        @keyframes blobFloat {
            0% {
                transform: translate(0, 0) scale(1) rotate(0deg);
            }

            33% {
                transform: translate(3vw, -5vh) scale(1.05) rotate(5deg);
            }

            66% {
                transform: translate(-3vw, 5vh) scale(0.95) rotate(-5deg);
            }

            100% {
                transform: translate(0, 0) scale(1) rotate(0deg);
            }
        }

        .header {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            color: var(--text);
            padding: calc(16px + env(safe-area-inset-top, 0px)) 20px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 1000;
            border-bottom: 1px solid var(--glass-border);
            box-shadow: var(--shadow-soft);
        }

        [data-theme="light"] .header {
            background: rgba(255, 255, 255, 0.95);
            /* Maintained somewhat lighter for contrast with grey bg, but consistent */
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
        }

        [data-theme="light"] .header-title {
            color: #111;
        }

        .header-title {
            font-size: 1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px
        }

        .header-btn {
            background: var(--bg-secondary);
            border: 1px solid var(--glass-border);
            color: var(--text);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .header-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.05);
        }

        .header-btn.hidden {
            visibility: hidden
        }

        .header-btn svg {
            width: 20px;
            height: 20px;
            fill: currentColor
        }

        /* Dark Mode Toggle Button */
        .theme-toggle {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: #fff;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .theme-toggle:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: rotate(180deg);
        }

        .theme-toggle svg {
            width: 18px;
            height: 18px;
            fill: currentColor;
            transition: all 0.3s ease;
        }

        .theme-toggle .sun-icon {
            position: absolute;
            opacity: 1;
            transform: rotate(0deg);
        }

        .theme-toggle .moon-icon {
            position: absolute;
            opacity: 0;
            transform: rotate(180deg);
        }

        [data-theme="dark"] .theme-toggle .sun-icon {
            opacity: 0;
            transform: rotate(-180deg);
        }

        [data-theme="dark"] .theme-toggle .moon-icon {
            opacity: 1;
            transform: rotate(0deg);
        }

        /* Smooth theme transition */
        *,
        *::before,
        *::after {
            transition-property: background-color, color, border-color, box-shadow;
            transition-duration: 0.3s;
            transition-timing-function: ease;
        }

        /* Exclude animations from theme transition */
        .logo-icon,
        .stat-box,
        .action-btn,
        .activity-item,
        .nav-item {
            transition-property: background-color, color, border-color, box-shadow, transform, opacity;
        }

        .main {
            padding: 24px 20px;
            width: 100%;
            max-width: 650px;
            margin: 0 auto;
            position: relative;
        }

        /* Responsive spacing and typography */
        @media (max-width: 480px) {
            .main {
                padding: 16px;
            }

            .header {
                padding: 12px 16px;
            }

            .header-title {
                font-size: 0.9rem;
            }

            .stat-box {
                padding: 16px;
                border-radius: var(--radius-lg);
            }

            .stat-box .stat-value {
                font-size: 1.5rem;
            }

            .action-btn {
                padding: 14px;
                border-radius: 16px;
                gap: 12px;
            }

            .action-btn .action-title {
                font-size: 0.75rem;
            }

            .card {
                padding: 20px;
                border-radius: var(--radius-lg);
            }
        }

        .page {
            display: none
        }

        .page.active {
            display: block;
            animation: fadeIn 0.4s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .home-logo {
            text-align: center;
            padding: 16px 0 12px
        }

        .home-logo .logo-icon {
            width: 56px;
            height: 56px;
            margin: 0 auto 6px;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 15px rgba(67, 97, 238, 0.3);
            overflow: hidden;
            position: relative;
            cursor: pointer;
        }

        /* Force animation on page load */
        .page.active .home-logo .logo-icon {
            animation: logoEntrance 0.8s cubic-bezier(0.34, 1.56, 0.64, 1) forwards !important;
        }

        /* Logo Animations */
        @keyframes logoEntrance {
            0% {
                transform: scale(0) rotate(-180deg);
                opacity: 0;
            }

            100% {
                transform: scale(1) rotate(0deg);
                opacity: 1;
            }
        }

        @keyframes logoPulse {

            0%,
            100% {
                transform: scale(1);
                box-shadow: 0 4px 15px rgba(67, 97, 238, 0.3);
            }

            50% {
                transform: scale(1.05);
                box-shadow: 0 6px 25px rgba(67, 97, 238, 0.5);
            }
        }

        @keyframes logoFloat {

            0%,
            100% {
                transform: translateY(0px);
            }

            50% {
                transform: translateY(-8px);
            }
        }

        @keyframes logoRotate {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        @keyframes logoShine {
            0% {
                left: -100%;
            }

            100% {
                left: 100%;
            }
        }

        /* Shine effect overlay */
        .home-logo .logo-icon::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 50%;
            height: 100%;
            background: linear-gradient(90deg,
                    transparent,
                    rgba(255, 255, 255, 0.6),
                    transparent);
            animation: logoShine 3s ease-in-out infinite;
            z-index: 1;
        }

        /* Add pulsing border for visibility */
        .home-logo .logo-icon::before {
            content: '';
            position: absolute;
            top: -3px;
            left: -3px;
            right: -3px;
            bottom: -3px;
            background: linear-gradient(45deg, var(--primary), var(--primary-light), var(--primary));
            border-radius: 16px;
            z-index: -1;
            animation: borderPulse 2s ease-in-out infinite;
        }

        @keyframes borderPulse {

            0%,
            100% {
                opacity: 0.3;
                transform: scale(1);
            }

            50% {
                opacity: 0.6;
                transform: scale(1.05);
            }
        }

        /* Hover effects */
        .home-logo .logo-icon:hover {
            animation: logoPulse 1s ease-in-out infinite;
            cursor: pointer;
        }

        /* Continuous floating animation */
        .home-logo .logo-icon.float {
            animation: logoFloat 3s ease-in-out infinite;
        }

        /* Rotating animation on click */
        .home-logo .logo-icon.rotate {
            animation: logoRotate 0.6s ease-in-out;
        }

        /* Bottom Navigation Bar */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--glass-bg);
            backdrop-filter: blur(40px);
            -webkit-backdrop-filter: blur(40px);
            border: none;
            border-top: 1px solid var(--glass-border);
            box-shadow: var(--shadow-soft);
            padding: 8px 0;
            padding-bottom: calc(8px + env(safe-area-inset-bottom, 0px));
            border-radius: 0;
            z-index: 1000;
            display: none;
            max-width: 100%;
            margin: 0;
        }

        [data-theme="light"] .bottom-nav {
            background: rgba(255, 255, 255, 0.95);
            border-top: 1px solid rgba(0, 0, 0, 0.1);
        }

        .bottom-nav.active {
            display: flex;
        }

        .bottom-nav-items {
            display: flex;
            justify-content: space-around;
            align-items: center;
            width: 100%;
            max-width: 480px;
            margin: 0 auto;
            padding: 0 8px;
        }

        .nav-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 6px 8px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            text-decoration: none;
            color: var(--text-secondary);
        }

        .nav-item .nav-icon {
            width: 24px;
            height: 24px;
            margin-bottom: 4px;
            transition: all 0.3s ease;
            position: relative;
        }

        .nav-item .nav-icon svg {
            width: 100%;
            height: 100%;
            fill: currentColor;
        }

        .nav-item .nav-label {
            font-size: 0.6rem;
            font-weight: 500;
            transition: all 0.3s ease;
            white-space: nowrap;
            letter-spacing: 0.2px;
        }

        .nav-item.active {
            color: var(--primary);
        }

        .nav-item.active .nav-icon {
            transform: translateY(-2px);
        }

        .nav-item.active .nav-label {
            font-weight: 600;
        }

        .nav-item::before {
            content: '';
            position: absolute;
            top: -8px;
            left: 50%;
            transform: translateX(-50%) scale(0);
            width: 32px;
            height: 3px;
            background: var(--primary);
            border-radius: 0 0 3px 3px;
            transition: transform 0.3s ease;
        }

        .nav-item.active::before {
            transform: translateX(-50%) scale(1);
        }

        /* Mobile specific adjustments */
        @media (max-width: 480px) {
            .bottom-nav {
                bottom: 16px;
                left: 12px;
                right: 12px;
                border-radius: 16px;
                padding: 8px 0;
            }

            .nav-item .nav-icon {
                width: 22px;
                height: 22px;
            }

            .nav-item .nav-label {
                font-size: 0.6rem;
            }
        }

        /* Dashboard Stats */
        .dashboard-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin: 16px 0;
        }

        .stat-box {
            background: var(--card);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: var(--radius-lg);
            padding: 20px;
            box-shadow: var(--shadow-card);
            border: 1px solid var(--glass-border);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            opacity: 0;
            transform: translateY(20px);
            animation: statBoxFadeIn 0.6s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .stat-box.blue,
        .stat-box.green,
        .stat-box.orange,
        .stat-box.purple {
            background: var(--card);
        }

        .stat-box::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 50%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(16, 185, 129, 0.05), transparent);
            transition: 0.5s;
        }

        .stat-box:hover::after {
            left: 100%;
        }

        @keyframes statBoxFadeIn {
            0% {
                opacity: 0;
                transform: translateY(20px) scale(0.95);
            }

            100% {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .stat-box:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(16, 185, 129, 0.15);
            border-color: rgba(16, 185, 129, 0.2);
        }

        .stat-box .stat-icon {
            width: 44px;
            height: 44px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 12px;
            transition: all 0.3s ease;
        }

        .stat-box:hover .stat-icon {
            transform: scale(1.05) rotate(-3deg);
        }

        .stat-box .stat-icon svg {
            width: 22px;
            height: 22px;
            fill: #fff;
            transition: all 0.3s ease;
        }

        .stat-box:hover .stat-icon svg {
            transform: scale(1.1);
        }

        .stat-box.blue .stat-icon {
            background: linear-gradient(135deg, #3b82f6, #60a5fa);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }

        .stat-box.green .stat-icon {
            background: linear-gradient(135deg, #10b981, #34d399);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }

        .stat-box.orange .stat-icon {
            background: linear-gradient(135deg, #f59e0b, #fbbf24);
            box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
        }

        .stat-box.purple .stat-icon {
            background: linear-gradient(135deg, #8b5cf6, #a78bfa);
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);
        }

        .stat-box .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--text);
            line-height: 1;
            margin-bottom: 6px;
        }

        .stat-box .stat-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            font-weight: 500;
        }

        /* Quick Actions */
        .quick-actions {
            margin: 16px 0;
        }

        .quick-actions h4 {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            animation: fadeInUp 0.6s ease-out 0.5s both;
        }

        .action-buttons {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        .action-btn {
            background: var(--card);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: var(--radius-lg);
            padding: 18px;
            display: flex;
            align-items: center;
            gap: 14px;
            box-shadow: var(--shadow-card);
            border: 1px solid var(--glass-border);
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            opacity: 0;
            transform: translateX(-20px);
            animation: actionSlideIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
            position: relative;
            overflow: hidden;
        }

        @keyframes actionSlideIn {
            0% {
                opacity: 0;
                transform: translateX(-20px) scale(0.95);
            }

            100% {
                opacity: 1;
                transform: translateX(0) scale(1);
            }
        }

        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(16, 185, 129, 0.12);
            border-color: rgba(16, 185, 129, 0.2);
        }

        .action-btn:active {
            transform: translateY(0) scale(0.98);
        }

        .action-btn .action-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            transition: all 0.3s ease;
        }

        .action-btn:hover .action-icon {
            transform: rotate(-5deg) scale(1.1);
        }

        .action-btn .action-icon svg {
            width: 20px;
            height: 20px;
            fill: #fff;
            transition: all 0.3s ease;
        }

        .action-btn:hover .action-icon svg {
            transform: scale(1.1);
        }

        .action-btn .action-text {
            flex: 1;
        }

        .action-btn .action-title {
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--text);
            margin-bottom: 2px;
        }

        .action-btn .action-desc {
            font-size: 0.65rem;
            color: var(--text-secondary);
        }

        /* Recent Activity */
        .recent-activity {
            margin: 16px 0;
        }

        .recent-activity h4 {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            animation: fadeInUp 0.6s ease-out 1s both;
        }

        .activity-list {
            background: var(--card);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: var(--radius-lg);
            padding: 16px;
            box-shadow: var(--shadow-card);
            border: 1px solid var(--glass-border);
            animation: fadeInUp 0.6s ease-out 1.1s both;
        }

        .activity-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px;
            border-bottom: 1px solid var(--glass-border);
            opacity: 0;
            animation: activityFadeIn 0.4s ease-out forwards;
        }

        .activity-item:nth-child(1) {
            animation-delay: 1.2s;
        }

        .activity-item:nth-child(2) {
            animation-delay: 1.3s;
        }

        .activity-item:nth-child(3) {
            animation-delay: 1.4s;
        }

        .activity-item:nth-child(4) {
            animation-delay: 1.5s;
        }

        .activity-item:nth-child(5) {
            animation-delay: 1.6s;
        }

        @keyframes activityFadeIn {
            0% {
                opacity: 0;
                transform: translateX(-10px);
            }

            100% {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .activity-item:last-child {
            border-bottom: none;
        }

        .activity-item .activity-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            font-weight: 600;
            font-size: 0.85rem;
            flex-shrink: 0;
            position: relative;
            animation: avatarPulse 2s ease-in-out infinite;
        }

        @keyframes avatarPulse {

            0%,
            100% {
                box-shadow: 0 0 0 0 rgba(67, 97, 238, 0.4);
            }

            50% {
                box-shadow: 0 0 0 8px rgba(67, 97, 238, 0);
            }
        }

        .activity-item .activity-info {
            flex: 1;
            min-width: 0;
        }

        .activity-item .activity-name {
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--text);
            margin-bottom: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .activity-item .activity-time {
            font-size: 0.7rem;
            color: #999;
        }

        .activity-item .activity-status {
            padding: 4px 8px;
            border-radius: 8px;
            font-size: 0.65rem;
            font-weight: 600;
            flex-shrink: 0;
        }

        /* Adjust main padding for bottom nav */
        body.has-bottom-nav .main {
            padding-bottom: 70px;
        }

        /* Smooth page transitions */
        .page {
            animation-duration: 0.3s;
        }

        /* Loading skeleton for dashboard */
        .skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s ease-in-out infinite;
        }

        @keyframes loading {
            0% {
                background-position: 200% 0;
            }

            100% {
                background-position: -200% 0;
            }
        }

        /* QR Generator Styles */
        .qr-options {
            margin: 20px 0;
        }

        .qr-options label {
            display: flex;
            align-items: center;
            margin-bottom: 12px;
            cursor: pointer;
            padding: 12px;
            border-radius: 8px;
            transition: background-color 0.3s ease;
        }

        .qr-options label:hover {
            background: rgba(67, 97, 238, 0.05);
        }

        .qr-options input[type="radio"] {
            width: auto;
            margin-right: 12px;
            margin-bottom: 0;
        }

        .qr-actions {
            display: flex;
            gap: 12px;
            margin: 20px 0;
        }

        .qr-actions button {
            flex: 1;
        }

        .qr-display {
            margin-top: 30px;
            padding: 20px;
            background: var(--glass-bg);
            border-radius: 12px;
            border: 1px solid var(--glass-border);
        }

        .qr-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--glass-border);
        }

        .qr-header h4 {
            margin: 0;
            color: var(--text);
        }

        .qr-cards-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 16px;
        }

        .qr-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            border: 2px solid #f0f0f0;
            transition: all 0.3s ease;
        }

        .qr-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        .qr-card .student-info {
            margin-bottom: 16px;
        }

        .qr-card .student-name {
            font-weight: 600;
            font-size: 1.1rem;
            color: var(--text);
            margin-bottom: 4px;
        }

        .qr-card .student-details {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 2px;
        }

        .qr-card .qr-code {
            margin: 16px 0;
            display: flex;
            justify-content: center;
        }

        .qr-card .qr-actions {
            display: flex;
            gap: 8px;
            margin-top: 16px;
        }

        .qr-card .qr-actions button {
            flex: 1;
            padding: 8px 12px;
            font-size: 0.8rem;
        }

        .card-indigo {
            border-top: 4px solid #6366f1;
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.03) 0%, rgba(139, 92, 246, 0.03) 100%);
        }

        /* Responsive adjustments */
        @media (max-width: 480px) {
            .qr-cards-container {
                grid-template-columns: 1fr;
            }

            .qr-actions {
                flex-direction: column;
            }
        }

        /* Responsive adjustments */
        @media (max-width: 360px) {
            .stat-box .stat-value {
                font-size: 1.5rem;
            }

            .stat-box .stat-label {
                font-size: 0.7rem;
            }

            .action-btn .action-title {
                font-size: 0.75rem;
            }

            .nav-item .nav-label {
                font-size: 0.6rem;
            }
        }

        /* Hide bottom nav on print */
        @media print {
            .bottom-nav {
                display: none !important;
            }
        }

        /* Accessibility: Reduced Motion */
        @media (prefers-reduced-motion: reduce) {

            *,
            *::before,
            *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }

            .logo-icon {
                animation: none !important;
            }

            .stat-box,
            .action-btn,
            .activity-item {
                opacity: 1 !important;
                transform: none !important;
                animation: none !important;
            }
        }

        .home-logo .logo-icon.custom-logo {
            background: transparent;
            box-shadow: none;
            width: 70px;
            height: 70px;
            animation: logoEntrance 0.8s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .home-logo .logo-icon.custom-logo:hover {
            animation: logoPulse 1s ease-in-out infinite;
        }

        .home-logo .logo-icon.custom-logo.float {
            animation: logoFloat 3s ease-in-out infinite;
        }

        .home-logo .logo-icon svg {
            width: 32px;
            height: 32px;
            fill: #fff
        }

        .home-logo .logo-icon img {
            width: 100%;
            height: 100%;
            object-fit: contain
        }

        .home-logo h1 {
            color: var(--primary);
            font-size: 1.4rem;
            font-weight: 700;
            letter-spacing: 2px;
            animation: titleSlideIn 0.6s ease-out 0.3s both;
        }

        @keyframes titleSlideIn {
            0% {
                transform: translateY(20px);
                opacity: 0;
            }

            100% {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .home-logo h1 span {
            color: var(--warning);
            display: inline-block;
            animation: letterBounce 0.6s ease-out 0.6s both;
        }

        @keyframes letterBounce {

            0%,
            100% {
                transform: translateY(0);
            }

            25% {
                transform: translateY(-10px);
            }

            50% {
                transform: translateY(0);
            }

            75% {
                transform: translateY(-5px);
            }
        }

        .home-logo p {
            color: #666;
            font-size: 0.65rem;
            margin-top: 2px;
            animation: fadeInUp 0.6s ease-out 0.5s both;
        }

        @keyframes fadeInUp {
            0% {
                transform: translateY(10px);
                opacity: 0;
            }

            100% {
                transform: translateY(0);
                opacity: 1;
            }
        }

        /* Legacy menu hidden */
        .menu-grid {
            display: none;
        }

        .card {
            background: var(--glass-bg);
            backdrop-filter: blur(40px);
            -webkit-backdrop-filter: blur(40px);
            border-radius: var(--radius-xl);
            padding: 28px;
            box-shadow: var(--shadow-soft);
            margin-bottom: 24px;
            border: 1px solid var(--glass-border);
            border-top: 1.5px solid var(--glass-highlight);
            border-left: 1.5px solid var(--glass-highlight);
            transition: transform 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative;
            overflow: hidden;
        }

        /* Card Accent Borders */
        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary), var(--primary-light));
            opacity: 0.8;
        }

        .card.card-blue::before {
            background: linear-gradient(90deg, #10b981, #34d399);
        }

        .card.card-green::before {
            background: linear-gradient(90deg, #059669, #10b981);
        }

        .card.card-orange::before {
            background: linear-gradient(90deg, #f59e0b, #fbbf24);
        }

        .card.card-purple::before {
            background: linear-gradient(90deg, #8b5cf6, #34d399);
        }

        .card.card-pink::before {
            background: linear-gradient(90deg, #ef4444, #f87171);
        }

        .card.card-teal::before {
            background: linear-gradient(90deg, #2dd4bf, #10b981);
        }

        .card h3 {
            color: var(--primary);
            font-size: .95rem;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px
        }

        .card h3 svg {
            width: 20px;
            height: 20px;
            fill: var(--primary)
        }

        button {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 8px;
            background: var(--primary);
            color: #fff;
            font-size: .9rem;
            font-weight: 600;
            cursor: pointer;
            margin-top: 6px
        }

        button:disabled {
            background: #ccc
        }

        button.sec {
            background: #fff;
            color: var(--text);
            border: 1px solid #ddd
        }

        button.success {
            background: var(--success)
        }

        input,
        select,
        textarea {
            width: 100%;
            padding: 10px;
            margin: 6px 0;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            font-size: .9rem;
            font-family: inherit
        }

        input:focus,
        select:focus {
            outline: none;
            border-color: var(--primary)
        }

        label {
            font-size: .75rem;
            color: #666;
            display: block;
            margin-top: 6px
        }

        .filter-row {
            display: flex;
            gap: 10px;
            margin-bottom: 8px
        }

        .filter-row select {
            flex: 0 0 90px;
            margin: 0
        }

        /* QR Generator specific styling */
        #page-qr-generator .filter-row select {
            flex: 1;
            min-width: 120px;
        }

        #page-qr-generator .filter-row #qr-siswa {
            flex: 2;
            min-width: 180px;
        }

        .filter-row input {
            flex: 1;
            margin: 0
        }

        .filter-row .search-btn {
            width: 40px;
            margin: 0;
            padding: 10px;
            flex-shrink: 0
        }

        #reader {
            width: 100%;
            border-radius: 10px;
            background: #000;
            min-height: 280px;
            overflow: hidden
        }

        .table-wrap {
            overflow-x: auto;
            margin-top: 8px
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: .75rem
        }

        th,
        td {
            padding: 10px 8px;
            text-align: left;
            border-bottom: 1px solid #eee
        }

        th {
            background: var(--primary);
            color: #fff;
            font-weight: 600
        }

        tr:nth-child(even) {
            background: #f8f9ff
        }

        tr.clickable {
            cursor: pointer
        }

        tr.clickable:hover {
            background: #e8f0ff
        }

        .badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: .7rem;
            font-weight: 600
        }

        .badge-success {
            background: #d4edda;
            color: #155724
        }

        .badge-warning {
            background: #fff3cd;
            color: #856404
        }

        .badge-danger {
            background: #f8d7da;
            color: #721c24
        }

        .badge-info {
            background: #cce5ff;
            color: #004085
        }

        .alert {
            padding: 10px;
            border-radius: 8px;
            margin-top: 10px;
            font-size: .85rem
        }

        .alert-success {
            background: #d4edda;
            color: #155724
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24
        }

        .alert-warning {
            background: #fff3cd;
            color: #856404
        }

        .hidden {
            display: none
        }

        .spinner {
            border: 2px solid #f3f3f3;
            border-top: 2px solid var(--primary);
            border-radius: 50%;
            width: 14px;
            height: 14px;
            animation: sp 1s linear infinite;
            display: inline-block;
            margin-right: 6px
        }

        @keyframes sp {
            100% {
                transform: rotate(360deg)
            }
        }

        .status {
            font-size: .8rem;
            color: var(--primary);
            text-align: center;
            margin-top: 8px;
            font-weight: 600
        }

        .rekap-nums {
            font-weight: 600;
            text-align: center
        }

        .rekap-nums.h {
            color: var(--success)
        }

        .rekap-nums.s {
            color: var(--orange)
        }

        .rekap-nums.i {
            color: var(--warning)
        }

        .rekap-nums.a {
            color: var(--danger)
        }

        .manual-form {
            background: #f8f9ff;
            padding: 12px;
            border-radius: 10px;
            margin-top: 10px
        }

        .manual-form.hidden {
            display: none
        }

        .selected-student {
            background: var(--primary);
            color: #fff;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 10px;
            font-size: 0.85rem
        }

        .time-input {
            width: 75px !important;
            flex: 0 0 75px !important;
            text-align: center;
            font-size: 0.75rem !important;
            padding: 5px !important
        }

        .del-btn {
            background: var(--danger);
            width: 28px;
            height: 28px;
            padding: 0;
            margin: 0;
            border-radius: 6px;
            font-size: 0.9rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .del-btn:hover {
            background: #d63031;
            transform: scale(1.1);
        }

        .del-btn svg {
            width: 16px;
            height: 16px;
            fill: #fff
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000
        }

        .modal.active {
            display: flex
        }

        .modal-content {
            background: #fff;
            padding: 24px;
            border-radius: 16px;
            width: 90%;
            max-width: 320px;
            text-align: center
        }

        .modal-content h4 {
            color: var(--primary);
            margin-bottom: 16px;
            font-size: 1.1rem
        }

        .modal-content input {
            text-align: center;
            font-size: 1.5rem;
            letter-spacing: 8px;
            margin-bottom: 10px
        }

        .pin-error {
            color: var(--danger);
            font-size: 0.8rem;
            margin-bottom: 10px
        }

        .logo-preview {
            width: 60px;
            height: 60px;
            border-radius: 12px;
            border: 2px dashed #ddd;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 8px 0;
            overflow: hidden;
            background: #f8f9ff
        }

        .logo-preview img {
            width: 100%;
            height: 100%;
            object-fit: contain
        }

        .help-text {
            font-size: 0.65rem;
            color: #999;
            margin-top: 4px
        }

        .scan-tipe {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 600;
            margin-left: 4px
        }

        .scan-tipe.masuk {
            background: #d4edda;
            color: #155724
        }

        .scan-tipe.pulang {
            background: #cce5ff;
            color: #004085
        }

        .chart-container {
            position: relative;
            height: 200px;
            margin: 16px 0
        }

        .stat-cards {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin: 12px 0
        }

        .stat-card {
            background: #f8f9ff;
            padding: 10px;
            border-radius: 8px;
            text-align: center
        }

        .stat-card .num {
            font-size: 1.2rem;
            font-weight: 700
        }

        .stat-card .lbl {
            font-size: 0.6rem;
            color: #666
        }

        .stat-card.h .num {
            color: var(--success)
        }

        .stat-card.s .num {
            color: var(--orange)
        }

        .stat-card.i .num {
            color: var(--warning)
        }

        .stat-card.a .num {
            color: var(--danger)
        }

        .export-btns {
            display: flex;
            gap: 8px;
            margin-top: 12px
        }

        .export-btns button {
            flex: 1
        }

        .print-report {
            display: none
        }

        @media print {
            body {
                background: #fff !important;
                padding: 0
            }

            .header,
            .modal {
                display: none !important
            }

            .main {
                display: block !important
            }

            .page {
                display: none !important
            }

            .print-report {
                display: block !important;
                padding: 20px;
                font-family: 'Poppins', sans-serif
            }

            .print-report h2 {
                font-size: 16px;
                margin: 0;
                text-align: center
            }

            .print-report .school {
                font-size: 14px;
                text-align: center;
                margin-bottom: 10px
            }

            .print-report .info {
                font-size: 11px;
                margin: 4px 0
            }

            .print-report table {
                width: 100%;
                border-collapse: collapse;
                font-size: 11px;
                margin-top: 10px
            }

            .print-report th,
            .print-report td {
                border: 1px solid #333;
                padding: 6px;
                text-align: center
            }

            .print-report th {
                background: var(--primary);
                color: #fff;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact
            }
        }

        /* Loading Page Styles */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            opacity: 1;
            transition: opacity 0.5s ease-out;
        }

        .loading-overlay.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .loading-logo {
            width: 120px;
            height: 120px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 24px;
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 255, 255, 0.2);
            animation: logoPulse 2s ease-in-out infinite;
        }

        .loading-logo svg {
            width: 60px;
            height: 60px;
            fill: #fff;
            animation: logoRotate 3s linear infinite;
        }

        .loading-text {
            color: #fff;
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 8px;
            animation: textGlow 2s ease-in-out infinite;
        }

        .loading-subtitle {
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.9rem;
            margin-bottom: 32px;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top: 3px solid #fff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .loading-progress {
            width: 200px;
            height: 4px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 2px;
            margin-top: 24px;
            overflow: hidden;
        }

        .loading-progress-bar {
            height: 100%;
            background: #fff;
            border-radius: 2px;
            width: 0%;
            animation: progressLoad 2s ease-out forwards;
        }

        @keyframes logoPulse {

            0%,
            100% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.05);
            }
        }

        @keyframes logoRotate {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        @keyframes textGlow {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.8;
            }
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        @keyframes progressLoad {
            0% {
                width: 0%;
            }

            100% {
                width: 100%;
            }
        }

        /* Responsive font size for student dropdown in mobile view */
        @media (max-width: 600px) {
            #lap-siswa {
                font-size: 0.75em !important;
                max-width: 100%;
                word-wrap: break-word;
                white-space: normal;
                overflow: hidden;
                text-overflow: ellipsis;
            }

            #lap-kelas {
                font-size: 0.8em !important;
            }

            .filter-row select {
                font-size: 0.8em !important;
                max-width: 100%;
            }
        }

        @media (max-width: 480px) {
            #lap-siswa {
                font-size: 0.7em !important;
            }

            #lap-kelas {
                font-size: 0.75em !important;
            }

            .filter-row {
                flex-direction: column;
                gap: 8px;
            }

            .filter-row select {
                width: 100%;
            }
        }


        /* ========================================
   HADIRQ DASHBOARD ENHANCEMENTS
   Version: 1.0
   Tanpa mengubah fungsionalitas existing
   ======================================== */

        /* ========== 1. ACCESSIBILITY IMPROVEMENTS ========== */

        /* Focus visible untuk keyboard navigation */
        *:focus-visible {
            outline: 3px solid var(--primary);
            outline-offset: 2px;
            border-radius: 4px;
        }

        /* Skip to main content link */
        .skip-link {
            position: absolute;
            top: -40px;
            left: 0;
            background: var(--primary);
            color: white;
            padding: 8px 16px;
            text-decoration: none;
            border-radius: 0 0 8px 0;
            z-index: 10000;
            font-weight: 600;
            transition: top 0.3s ease;
        }

        .skip-link:focus {
            top: 0;
        }

        /* High contrast mode support */
        @media (prefers-contrast: high) {
            :root {
                --glass-bg: rgba(255, 255, 255, 0.15);
                --glass-border: rgba(255, 255, 255, 0.3);
            }

            .stat-box,
            .action-btn,
            .card {
                border-width: 2px;
            }

            button {
                border: 2px solid currentColor;
            }
        }

        /* Screen reader only content */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border-width: 0;
        }

        /* ========== 2. PERFORMANCE IMPROVEMENTS ========== */

        /* Lazy load images */
        img[loading="lazy"] {
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        img[loading="lazy"].loaded {
            opacity: 1;
        }

        /* Reduce animations for performance and accessibility */
        @media (prefers-reduced-motion: reduce) {

            *,
            *::before,
            *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
                scroll-behavior: auto !important;
            }

            .logo-icon,
            .stat-box,
            .action-btn,
            .activity-item,
            .blob {
                animation: none !important;
                opacity: 1 !important;
                transform: none !important;
            }
        }

        /* Will-change for animated elements (performance) */
        .stat-box,
        .action-btn,
        .nav-item {
            will-change: transform;
        }

        .stat-box:hover,
        .action-btn:hover,
        .nav-item:hover {
            will-change: auto;
        }

        /* ========== 3. UX IMPROVEMENTS ========== */

        /* Loading skeleton */
        .skeleton {
            background: linear-gradient(90deg,
                    var(--glass-bg) 25%,
                    var(--glass-highlight) 50%,
                    var(--glass-bg) 75%);
            background-size: 200% 100%;
            animation: loading 1.5s ease-in-out infinite;
            border-radius: 8px;
            min-height: 20px;
        }

        @keyframes loading {
            0% {
                background-position: 200% 0;
            }

            100% {
                background-position: -200% 0;
            }
        }

        /* Empty state */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #999;
        }

        .empty-state svg {
            width: 80px;
            height: 80px;
            fill: #ccc;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .empty-state h4 {
            font-size: 1rem;
            margin-bottom: 8px;
            color: var(--text);
            opacity: 0.7;
        }

        .empty-state p {
            font-size: 0.85rem;
            opacity: 0.6;
        }

        /* Error state */
        .error-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--danger);
        }

        .error-state svg {
            width: 60px;
            height: 60px;
            fill: var(--danger);
            margin-bottom: 16px;
            opacity: 0.7;
        }

        .error-state h4 {
            font-size: 1rem;
            margin-bottom: 8px;
        }

        .error-state p {
            font-size: 0.85rem;
            margin-bottom: 16px;
        }

        /* Pull to refresh indicator */
        .pull-to-refresh {
            position: fixed;
            top: 60px;
            left: 50%;
            transform: translateX(-50%) scale(0);
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            padding: 12px 24px;
            border-radius: 24px;
            border: 1px solid var(--glass-border);
            color: var(--text);
            font-size: 0.85rem;
            font-weight: 600;
            z-index: 999;
            transition: transform 0.3s ease;
            pointer-events: none;
        }

        .pull-to-refresh.active {
            transform: translateX(-50%) scale(1);
        }

        /* Toast notification */
        .toast {
            position: fixed;
            bottom: calc(100px + env(safe-area-inset-bottom, 0px));
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--glass-bg);
            backdrop-filter: blur(40px);
            -webkit-backdrop-filter: blur(40px);
            color: var(--text);
            padding: 16px 24px;
            border-radius: 16px;
            border: 1px solid var(--glass-border);
            box-shadow: var(--shadow-soft);
            z-index: 9999;
            max-width: 90%;
            text-align: center;
            font-size: 0.9rem;
            font-weight: 500;
            opacity: 0;
            transition: all 0.3s ease;
            pointer-events: none;
        }

        .toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }

        .toast.success {
            border-left: 4px solid var(--success);
        }

        .toast.error {
            border-left: 4px solid var(--danger);
        }

        .toast.warning {
            border-left: 4px solid var(--warning);
        }

        .toast.info {
            border-left: 4px solid #3b82f6;
        }

        /* Offline indicator */
        .offline-indicator {
            position: fixed;
            top: 0;
            left: 50%;
            transform: translateX(-50%) translateY(-100%);
            background: var(--danger);
            color: white;
            padding: 12px 20px;
            padding-top: calc(12px + env(safe-area-inset-top, 0px));
            border-radius: 0 0 12px 12px;
            font-size: 0.8rem;
            font-weight: 600;
            z-index: 10000;
            transition: transform 0.3s ease;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            min-width: 250px;
            text-align: center;
        }

        .offline-indicator.show {
            transform: translateX(-50%) translateY(0);
        }

        /* ========== 4. CONSISTENCY IMPROVEMENTS ========== */

        /* Unified color scheme */
        .unified-primary {
            --primary: #10b981;
            --primary-light: #34d399;
            --primary-dark: #065f46;
        }

        /* Consistent button styles */
        button,
        .btn {
            font-family: 'Roboto', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            font-weight: 500;
            border-radius: 8px;
            transition: all 0.2s ease;
            cursor: pointer;
            border: none;
        }

        button:hover:not(:disabled),
        .btn:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        button:active:not(:disabled),
        .btn:active:not(:disabled) {
            transform: translateY(0);
        }

        button:disabled,
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Consistent form inputs */
        input,
        select,
        textarea {
            font-family: 'Roboto', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            font-size: 14px;
            transition: all 0.2s ease;
        }

        /* Compact select dropdown */
        select {
            padding: 8px 12px;
            height: 38px;
            line-height: 1.4;
            font-weight: 400;
        }

        select option {
            padding: 6px 12px;
            font-size: 14px;
        }

        input:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
        }

        /* ========== 5. ADDITIONAL ENHANCEMENTS ========== */

        /* Smooth scroll behavior */
        html {
            scroll-behavior: smooth;
        }

        @media (prefers-reduced-motion: reduce) {
            html {
                scroll-behavior: auto;
            }
        }

        /* Better tap targets for mobile */
        @media (max-width: 768px) {

            button,
            .btn,
            .action-btn,
            .nav-item,
            a {
                min-height: 44px;
                min-width: 44px;
            }
        }

        /* Loading state for buttons */
        button[aria-busy="true"],
        .btn[aria-busy="true"] {
            position: relative;
            color: transparent;
            pointer-events: none;
        }

        button[aria-busy="true"]::after,
        .btn[aria-busy="true"]::after {
            content: '';
            position: absolute;
            width: 16px;
            height: 16px;
            top: 50%;
            left: 50%;
            margin-left: -8px;
            margin-top: -8px;
            border: 2px solid transparent;
            border-top-color: currentColor;
            border-radius: 50%;
            animation: button-spin 0.6s linear infinite;
        }

        @keyframes button-spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* Improved table responsiveness */
        @media (max-width: 600px) {
            .table-wrap {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }

            table {
                min-width: 500px;
            }
        }

        /* Better focus for dark mode */
        [data-theme="dark"] *:focus-visible {
            outline-color: var(--primary-light);
        }

        /* Improved contrast for badges in dark mode */
        [data-theme="dark"] .badge-success {
            background: rgba(16, 185, 129, 0.2);
            color: #34d399;
            border: 1px solid rgba(16, 185, 129, 0.3);
        }

        [data-theme="dark"] .badge-warning {
            background: rgba(251, 191, 36, 0.2);
            color: #fbbf24;
            border: 1px solid rgba(251, 191, 36, 0.3);
        }

        [data-theme="dark"] .badge-danger {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        /* Print styles */
        @media print {

            .skip-link,
            .toast,
            .offline-indicator,
            .pull-to-refresh,
            .bottom-nav,
            .header-btn,
            .theme-toggle {
                display: none !important;
            }

            body {
                background: white !important;
                color: black !important;
            }
        }

        /* Reduced transparency for better readability */
        @media (prefers-reduced-transparency: reduce) {

            .glass-bg-container,
            .blob {
                opacity: 0.1 !important;
            }

            .card,
            .stat-box,
            .action-btn {
                background: var(--card) !important;
                backdrop-filter: none !important;
            }
        }
    </style>
</head>

<body class="unified-primary">
    <!-- Skip link -->
    <a href="#main-content" class="skip-link">Skip to main content</a>

    <!-- Indicators -->
    <div class="offline-indicator" id="offline-indicator" role="alert" aria-live="polite">
        <span> Tidak ada koneksi internet</span>
    </div>

    <div class="pull-to-refresh" id="pull-to-refresh" role="status" aria-live="polite">
        <span> Tarik untuk refresh</span>
    </div>

    <div class="toast" id="toast" role="alert" aria-live="polite"></div>
    <!-- Decorative Background Elements -->
    <div class="glass-bg-container">
        <div class="blob blob-1"></div>
        <div class="blob blob-2"></div>
        <div class="blob blob-3"></div>
    </div>

    <!-- Loading Page -->
    <div id="loading-overlay" class="loading-overlay">
        <div class="loading-logo">
            <svg>
                <use href="#icon-clipboard" />
            </svg>
        </div>
        <div class="loading-text">HADIR<span style="color: #ffd166;">Q</span></div>
        <div class="loading-subtitle">Presensi Digital Madrasah</div>
        <div class="loading-spinner"></div>
        <div class="loading-progress">
            <div class="loading-progress-bar"></div>
        </div>
    </div>

    <!-- SVG Icons -->
    <svg style="display: none;">
        <defs>
            <symbol id="icon-manual" viewBox="0 0 24 24">
                <path
                    d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34a.9959.9959 0 0 0-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z" />
            </symbol>
            <symbol id="icon-users" viewBox="0 0 24 24">
                <path
                    d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm-5 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z" />
            </symbol>
            <symbol id="icon-list" viewBox="0 0 24 24">
                <path
                    d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z" />
            </symbol>
            <symbol id="icon-chart" viewBox="0 0 24 24">
                <path
                    d="M19 3h-4V3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 0c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zm-2 14l-4-4 1.41-1.41L10 14.17l6.59-6.59L18 9l-8 8z" />
            </symbol>
            <symbol id="icon-settings" viewBox="0 0 24 24">
                <path
                    d="M19.14 12.94c.04-.31.06-.63.06-.94 0-.31-.02-.63-.06-.94l2.03-1.58c.18-.14.23-.41.12-.61l-1.92-3.32c-.12-.22-.37-.29-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54c-.04-.24-.24-.41-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.04.31-.06.63-.06.94s.02.63.06.94l-2.03 1.58c-.18.14-.23.41-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z" />
            </symbol>
            <symbol id="icon-home" viewBox="0 0 24 24">
                <path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z" />
            </symbol>
            <symbol id="icon-clipboard" viewBox="0 0 24 24">
                <path
                    d="M19 3h-4V3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 0c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zm-2 14l-4-4 1.41-1.41L10 14.17l6.59-6.59L18 9l-8 8z" />
            </symbol>
            <symbol id="icon-camera" viewBox="0 0 24 24">
                <circle cx="12" cy="12" r="3.2" />
                <path
                    d="M9 2L7.17 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2h-3.17L15 2H9zm3 15c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5z" />
            </symbol>
            <symbol id="icon-search" viewBox="0 0 24 24">
                <path
                    d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z" />
            </symbol>
            <symbol id="icon-download" viewBox="0 0 24 24">
                <path
                    d="M19 9h-4V3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 0c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zm-2 14l-4-4 1.41-1.41L10 14.17l6.59-6.59L18 9l-8 8z" />
            </symbol>
            <symbol id="icon-print" viewBox="0 0 24 24">
                <path
                    d="M19 8H5c-1.66 0-3 1.34-3 3v6h4v4h12v-4h4v-6c0-1.66-1.34-3-3-3zm-3 11H8v-5h8v5zm3-7c-.55 0-1-.45-1-1s.45-1 1-1 1 .45 1 1-.45 1-1 1zm-1-9H6v4h12V3z" />
            </symbol>
            <symbol id="icon-refresh" viewBox="0 0 24 24">
                <path
                    d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z" />
            </symbol>
            <symbol id="icon-check" viewBox="0 0 24 24">
                <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z" />
            </symbol>
            <symbol id="icon-sun" viewBox="0 0 24 24">
                <path
                    d="M12 7c-2.76 0-5 2.24-5 5s2.24 5 5 5 5-2.24 5-5-2.24-5-5-5zM2 13h2c.55 0 1-.45 1-1s-.45-1-1-1H2c-.55 0-1 .45-1 1s.45 1 1 1zm18 0h2c.55 0 1-.45 1-1s-.45-1-1-1h-2c-.55 0-1 .45-1 1s.45 1 1 1zM11 2v2c0 .55.45 1 1 1s1-.45 1-1V2c0-.55-.45-1-1-1s-1 .45-1 1zm0 18v2c0 .55.45 1 1 1s1-.45 1-1v-2c0-.55-.45-1-1-1s-1 .45-1 1zM5.99 4.58c-.39-.39-1.03-.39-1.41 0-.39.39-.39 1.03 0 1.41l1.06 1.06c.39.39 1.03.39 1.41 0s.39-1.03 0-1.41L5.99 4.58zm12.37 12.37c-.39-.39-1.03-.39-1.41 0-.39.39-.39 1.03 0 1.41l1.06 1.06c.39.39 1.03.39 1.41 0 .39-.39.39-1.03 0-1.41l-1.06-1.06zm1.06-10.96c.39-.39.39-1.03 0-1.41-.39-.39-1.03-.39-1.41 0l-1.06 1.06c-.39.39-.39 1.03 0 1.41s1.03.39 1.41 0l1.06-1.06zM7.05 18.36c.39-.39.39-1.03 0-1.41-.39-.39-1.03-.39-1.41 0l-1.06 1.06c-.39.39-.39 1.03 0 1.41s1.03.39 1.41 0l1.06-1.06z" />
            </symbol>
            <symbol id="icon-moon" viewBox="0 0 24 24">
                <path
                    d="M9.37 5.51c-.18.64-.27 1.31-.27 1.99 0 4.08 3.32 7.4 7.4 7.4.68 0 1.35-.09 1.99-.27C17.45 17.19 14.93 19 12 19c-3.86 0-7-3.14-7-7 0-2.93 1.81-5.45 4.37-6.49zM12 3c-4.97 0-9 4.03-9 9s4.03 9 9 9 9-4.03 9-9c0-.46-.04-.92-.1-1.36-.98 1.37-2.58 2.26-4.4 2.26-2.98 0-5.4-2.42-5.4-5.4 0-1.81.89-3.42 2.26-4.4-.44-.06-.9-.1-1.36-.1z" />
            </symbol>
            <symbol id="icon-qr" viewBox="0 0 24 24">
                <path
                    d="M3 11h8V3H3v8zm2-6h4v4H5V5zM3 21h8v-8H3v8zm2-6h4v4H5v-4zM13 3v8h8V3h-8zm6 6h-4V5h4v4zM19 13h2v2h-2zM13 13h2v2h-2zM15 15h2v2h-2zM13 17h2v2h-2zM15 19h2v2h-2zM17 17h2v2h-2zM17 13h2v2h-2zM19 15h2v2h-2z" />
            </symbol>
            <symbol id="icon-calendar" viewBox="0 0 24 24">
                <path
                    d="M19 3h-1V1h-2v2H8V1H6v2H5c-1.11 0-1.99.9-1.99 2L3 19c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V8h14v11zM7 10h5v5H7z" />
            </symbol>
            <symbol id="icon-message" viewBox="0 0 24 24">
                <path
                    d="M20 2H4c-1.1 0-1.99.9-1.99 2L2 22l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-2 12H6v-2h12v2zm0-3H6V9h12v2zm0-3H6V6h12v2z" />
            </symbol>
            <symbol id="icon-lock" viewBox="0 0 24 24">
                <path
                    d="M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zm-6 9c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm3.1-9H8.9V6c0-1.71 1.39-3.1 3.1-3.1 1.71 0 3.1 1.39 3.1 3.1v2z" />
            </symbol>
            <symbol id="icon-speaker" viewBox="0 0 24 24">
                <path
                    d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z" />
            </symbol>
        </defs>
    </svg>

    <div id="pin-modal" class="modal">
        <div class="modal-content">
            <h4> Masukkan PIN Admin</h4>
            <input type="password" id="pin-input" maxlength="6" placeholder="****" inputmode="numeric">
            <div id="pin-error" class="pin-error hidden"></div>
            <button id="pin-btn" onclick="verifyPinAndOpen()">Masuk</button>
            <button class="sec" onclick="closePinModal()">Batal</button>
        </div>
    </div>

    <div class="header">
        <div class="header-title" style="color: var(--text);"><svg style="width:20px;height:20px;fill:var(--primary)">
                <use href="#icon-clipboard" />
            </svg> HadirQ</div>
        <div style="display:flex;gap:8px;align-items:center;">
            <button class="theme-toggle" onclick="toggleTheme()" title="Toggle Dark Mode">
                <svg class="sun-icon">
                    <use href="#icon-sun" />
                </svg>
                <svg class="moon-icon">
                    <use href="#icon-moon" />
                </svg>
            </button>
            <button id="menu-btn" class="header-btn hidden" onclick="goHome()"><svg>
                    <use href="#icon-home" />
                </svg></button>
        </div>
    </div>


    <main id="main-content" class="main" role="main">
        <div id="page-home" class="page active">
            <div class="home-logo">
                <div class="logo-icon" id="home-logo-container"
                    style="animation: logoEntrance 0.8s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;">
                    <svg id="default-logo-icon">
                        <use href="#icon-clipboard" />
                    </svg>
                </div>
                <h1>HADIR<span>Q</span></h1>
                <p id="school-name-display">PRESENSI DIGITAL MADRASAH</p>
            </div>

            <!-- Dashboard Stats -->
            <div class="dashboard-stats">
                <div class="stat-box blue" onclick="goTo('siswa')">
                    <div class="stat-icon">
                        <svg>
                            <use href="#icon-users" />
                        </svg>
                    </div>
                    <div class="stat-value" id="dash-total-siswa">0</div>
                    <div class="stat-label">Total Siswa</div>
                </div>
                <div class="stat-box green" onclick="goTo('presensi')">
                    <div class="stat-icon">
                        <svg>
                            <use href="#icon-clipboard" />
                        </svg>
                    </div>
                    <div class="stat-value" id="dash-hadir-hari-ini">0</div>
                    <div class="stat-label">Hadir Hari Ini</div>
                </div>
                <div class="stat-box orange" onclick="goTo('manual')">
                    <div class="stat-icon">
                        <svg>
                            <use href="#icon-manual" />
                        </svg>
                    </div>
                    <div class="stat-value" id="dash-belum-hadir">0</div>
                    <div class="stat-label">Belum Hadir</div>
                </div>
                <div class="stat-box purple" onclick="goTo('laporan')">
                    <div class="stat-icon">
                        <svg>
                            <use href="#icon-chart" />
                        </svg>
                    </div>
                    <div class="stat-value" id="dash-persentase">0%</div>
                    <div class="stat-label">Kehadiran</div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="quick-actions">
                <h4>Aksi Cepat</h4>
                <div class="action-buttons">
                    <div class="action-btn" onclick="goTo('scan')">
                        <div class="action-icon" style="background: linear-gradient(135deg, #10b981, #34d399)">
                            <svg>
                                <use href="#icon-camera" />
                            </svg>
                        </div>
                        <div class="action-text">
                            <div class="action-title">Scan QR</div>
                            <div class="action-desc">Presensi cepat</div>
                        </div>
                    </div>
                    <div class="action-btn" onclick="goTo('manual')">
                        <div class="action-icon" style="background: linear-gradient(135deg, #f72585, #ff4d6d)">
                            <svg>
                                <use href="#icon-manual" />
                            </svg>
                        </div>
                        <div class="action-text">
                            <div class="action-title">Manual</div>
                            <div class="action-desc">Input manual</div>
                        </div>
                    </div>
                    <div class="action-btn" onclick="goTo('laporan')">
                        <div class="action-icon" style="background: linear-gradient(135deg, #7209b7, #b5179e)">
                            <svg>
                                <use href="#icon-chart" />
                            </svg>
                        </div>
                        <div class="action-text">
                            <div class="action-title">Laporan</div>
                            <div class="action-desc">Lihat rekap</div>
                        </div>
                    </div>
                    <div class="action-btn" onclick="openSettings()">
                        <div class="action-icon" style="background: linear-gradient(135deg, #6ee7b7, #10b981)">
                            <svg>
                                <use href="#icon-settings" />
                            </svg>
                        </div>
                        <div class="action-text">
                            <div class="action-title">Pengaturan</div>
                            <div class="action-desc">Konfigurasi</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recent Activity -->
            <div class="recent-activity">
                <h4>Aktivitas Terbaru</h4>
                <div class="activity-list" id="recent-activity-list">
                    <div style="text-align:center;padding:20px;color:#999;font-size:0.8rem">
                        Memuat aktivitas...
                    </div>
                </div>
            </div>
        </div>

        <div id="page-scan" class="page">
            <div class="card" style="border-top: 2px solid #10b981;">
                <h3><svg style="fill: #10b981;">
                        <use href="#icon-camera" />
                    </svg> Scan QR</h3>
                <div id="reader"></div>
                <div id="scan-status" class="status">Siap</div>
                <div id="scan-result" class="alert hidden"></div><button id="start-btn" onclick="startCam()">Mulai
                    Kamera</button><button id="stop-btn" onclick="stopCam()" class="sec" disabled>Stop</button>
            </div>
        </div>

        <div id="page-manual" class="page">
            <div class="card card-pink">
                <h3><svg>
                        <use href="#icon-manual" />
                    </svg> Presensi Manual</h3>
                <p style="font-size:0.75rem;color:#666;margin-bottom:10px">Pilih siswa yang belum presensi:</p>
                <div class="filter-row"><select id="manual-kelas" onchange="loadAbsentStudents()">
                        <option value="">Kelas</option>
                    </select><input type="text" id="manual-search" placeholder="Cari"
                        onkeyup="loadAbsentStudents()"><button class="search-btn" onclick="loadAbsentStudents()"><svg
                            style="width:16px;height:16px;fill:#fff">
                            <use href="#icon-search" />
                        </svg></button></div>
                <div class="table-wrap">
                    <table>
                        <thead>
                            <tr>
                                <th>No</th>
                                <th>NIS</th>
                                <th>Nama</th>
                                <th>Kelas</th>
                            </tr>
                        </thead>
                        <tbody id="absent-tbody">
                            <tr>
                                <td colspan="4" style="text-align:center;color:#999">Memuat...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div id="manual-form" class="manual-form hidden">
                    <div id="selected-student" class="selected-student"></div><label>Status</label><select
                        id="m-status">
                        <option>Hadir</option>
                        <option>Sakit</option>
                        <option>Ijin</option>
                        <option>Alpha</option>
                    </select><label>Keterangan</label><textarea id="m-ket" rows="2"
                        placeholder="Opsional"></textarea><button id="m-btn"
                        onclick="submitManualPresensi()">Kirim</button><button class="sec"
                        onclick="cancelManual()">Batal</button>
                </div>
                <div id="manual-result" class="alert hidden"></div>
            </div>
        </div>

        <div id="page-siswa" class="page">
            <div class="card card-green">
                <h3><svg>
                        <use href="#icon-users" />
                    </svg> Data Siswa</h3>
                <div class="filter-row"><select id="siswa-kelas" onchange="loadDataSiswa()">
                        <option value="">Kelas</option>
                    </select><input type="text" id="siswa-nama" placeholder="Nama" onkeyup="loadDataSiswa()"><button
                        class="search-btn" onclick="loadDataSiswa()"><svg style="width:16px;height:16px;fill:#fff">
                            <use href="#icon-search" />
                        </svg></button></div>
                <div class="table-wrap">
                    <table>
                        <thead>
                            <tr>
                                <th>No</th>
                                <th>NIS</th>
                                <th>Nama</th>
                                <th>Kelas</th>
                            </tr>
                        </thead>
                        <tbody id="siswa-tbody">
                            <tr>
                                <td colspan="4" style="text-align:center;color:#999">Memuat...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="page-presensi" class="page">
            <div class="card card-orange">
                <h3><svg>
                        <use href="#icon-list" />
                    </svg> Data Presensi</h3>
                <div class="filter-row"><input type="date" id="pres-tgl" onchange="loadDataPresensi()"><select
                        id="pres-kelas" onchange="loadDataPresensi()">
                        <option value="">Kelas</option>
                    </select><button class="search-btn" onclick="loadDataPresensi()"><svg
                            style="width:16px;height:16px;fill:#fff">
                            <use href="#icon-search" />
                        </svg></button></div>
                <div class="table-wrap">
                    <table>
                        <thead>
                            <tr>
                                <th>Waktu</th>
                                <th>Nama</th>
                                <th>Kelas</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="presensi-tbody">
                            <tr>
                                <td colspan="4" style="text-align:center;color:#999">Memuat...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="page-laporan" class="page">
            <div class="card card-purple">
                <h3><svg>
                        <use href="#icon-chart" />
                    </svg> Laporan & Export</h3>
                <div class="filter-row"><select id="lap-kelas" onchange="loadSiswaDropdown()">
                        <option value="">Semua Kelas</option>
                    </select><select id="lap-siswa">
                        <option value="">Semua Siswa</option>
                    </select></div>
                <div class="filter-row"><input type="date" id="lap-dari"><input type="date" id="lap-sampai"><button
                        class="search-btn" onclick="loadLaporan()"><svg style="width:16px;height:16px;fill:#fff">
                            <use href="#icon-search" />
                        </svg></button></div>
                <div id="laporan-result" class="alert hidden"></div>
                <div class="stat-cards">
                    <div class="stat-card h"
                        style="background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.2);">
                        <div class="num" id="stat-h">0</div>
                        <div class="lbl">Hadir</div>
                    </div>
                    <div class="stat-card s"
                        style="background: rgba(245, 158, 11, 0.1); border: 1px solid rgba(245, 158, 11, 0.2);">
                        <div class="num" id="stat-s">0</div>
                        <div class="lbl">Sakit</div>
                    </div>
                    <div class="stat-card i"
                        style="background: rgba(251, 191, 36, 0.1); border: 1px solid rgba(251, 191, 36, 0.2);">
                        <div class="num" id="stat-i">0</div>
                        <div class="lbl">Ijin</div>
                    </div>
                    <div class="stat-card a"
                        style="background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.2);">
                        <div class="num" id="stat-a">0</div>
                        <div class="lbl">Alpha</div>
                    </div>
                </div>
                <div class="chart-container"><canvas id="rekapChart"></canvas></div>
                <div class="export-btns"><button onclick="exportExcel()"><svg
                            style="width:14px;height:14px;fill:#fff;margin-right:4px;vertical-align:middle">
                            <use href="#icon-download" />
                        </svg>Excel</button><button class="sec" onclick="printPDF()"><svg
                            style="width:14px;height:14px;fill:var(--text);margin-right:4px;vertical-align:middle">
                            <use href="#icon-print" />
                        </svg>Cetak</button></div>
                <div id="export-result" class="alert hidden"></div>
            </div>
        </div>

        <!-- QR Generator Page -->
        <div id="page-qr-generator" class="page">
            <div class="card card-indigo">
                <h3><svg>
                        <use href="#icon-qr" />
                    </svg> Generate QR Code NIS</h3>
                <p style="margin-bottom: 20px; opacity: 0.8;">Buat QR Code untuk kartu presensi siswa</p>

                <!-- Filter Section -->
                <div class="filter-row">
                    <select id="qr-kelas" onchange="loadSiswaForQR()">
                        <option value="">Pilih Kelas</option>
                    </select>
                    <select id="qr-siswa">
                        <option value="">Pilih Siswa</option>
                    </select>
                </div>

                <!-- Generate Options -->
                <div class="qr-options">
                    <label>
                        <input type="radio" name="qr-mode" value="single" checked onchange="toggleQRMode()">
                        Generate QR Code Satu Siswa
                    </label>
                    <label>
                        <input type="radio" name="qr-mode" value="batch" onchange="toggleQRMode()">
                        Generate QR Code Seluruh Kelas
                    </label>
                </div>

                <!-- Generate Button -->
                <div class="qr-actions">
                    <button onclick="generateQRCode()" id="generate-btn">
                        <svg style="width:16px;height:16px;fill:#fff;margin-right:6px">
                            <use href="#icon-qr" />
                        </svg>
                        Generate QR Code
                    </button>
                    <button class="sec" onclick="downloadAllQR()" id="download-all-btn" style="display:none;">
                        <svg style="width:16px;height:16px;fill:var(--text);margin-right:6px">
                            <use href="#icon-download" />
                        </svg>
                        Download Semua
                    </button>
                </div>

                <div id="qr-result" class="alert hidden"></div>

                <!-- QR Display Area -->
                <div id="qr-display-area" class="qr-display hidden">
                    <div class="qr-header">
                        <h4>QR Code Generated</h4>
                        <button class="sec" onclick="clearQRDisplay()">Clear</button>
                    </div>
                    <div id="qr-cards-container"></div>
                </div>
            </div>
        </div>

        <div id="page-settings" class="page">
            <div class="card card-teal">
                <h3><svg>
                        <use href="#icon-settings" />
                    </svg> Pengaturan Umum</h3><label>Nama Madrasah/Sekolah</label><input type="text"
                    id="set-schoolname" placeholder="Contoh: MI NEGERI 1 KOTA"><button
                    onclick="saveSchoolNameSetting()">Simpan
                    Nama</button>
                <div id="school-result" class="alert hidden"></div><label>Logo (ID File Google Drive atau URL)</label>
                <div class="logo-preview" id="logo-preview"><span>No Logo</span></div><input type="text"
                    id="set-logourl" placeholder="ID File Drive atau URL Gambar"><button
                    onclick="saveLogoUrlSetting()">Simpan Logo</button>

                <label style="margin-top:12px">URL Kop Surat (Gambar)</label>
                <div class="logo-preview" id="kop-preview" style="height:60px;width:100%;object-fit:cover"><span>No
                        Kop</span></div>
                <input type="text" id="set-kopurl" placeholder="URL Gambar Kop Surat">
                <button onclick="saveKopSuratUrlSetting()">Simpan Kop Surat</button>

                <div id="logo-result" class="alert hidden"></div>
            </div>
            <div class="card card-blue">
                <h3><svg>
                        <use href="#icon-clipboard" />
                    </svg> Jadwal Presensi</h3>
                <div class="table-wrap">
                    <table>
                        <thead>
                            <tr>
                                <th style="width:30px"></th>
                                <th>Hari</th>
                                <th>Masuk</th>
                                <th>Akhir</th>
                                <th>Pulang</th>
                                <th>Akhir</th>
                            </tr>
                        </thead>
                        <tbody id="schedule-tbody"></tbody>
                    </table>
                </div><button onclick="saveScheduleSetting()" style="margin-top:12px">Simpan Jadwal</button>
                <div id="schedule-result" class="alert hidden"></div>
            </div>
            <div class="card card-yellow">
                <h3><svg style="fill: #f59e0b; width: 20px; height: 20px; margin-right: 8px; vertical-align: middle;">
                        <use href="#icon-calendar" />
                    </svg>Hari Libur</h3>
                <div class="filter-row"><input type="date" id="holiday-date"><input type="text" id="holiday-desc"
                        placeholder="Ket"><button class="search-btn" onclick="addHolidaySetting()">+</button></div>
                <div class="table-wrap">
                    <table>
                        <thead>
                            <tr>
                                <th>Tanggal</th>
                                <th>Keterangan</th>
                                <th style="width:40px"></th>
                            </tr>
                        </thead>
                        <tbody id="holidays-tbody"></tbody>
                    </table>
                </div>
            </div>
            <div class="card card-green">
                <h3><svg style="fill: #10b981; width: 20px; height: 20px; margin-right: 8px; vertical-align: middle;">
                        <use href="#icon-message" />
                    </svg>Pengaturan WhatsApp (MPWA)</h3><label><input type="checkbox" id="mpwa-enabled"
                        style="width:auto;margin:0 6px 0 0;vertical-align:middle">Aktifkan Notifikasi
                    WA</label><label>ID
                    Sender (Device ID)</label><input type="text" id="mpwa-sender" placeholder="Contoh: 12345"><label>WA
                    Gateway URL</label><input type="text" id="mpwa-url"
                    placeholder="https://gateway.pdmhadirq.cloud/api/send-message"><label>API
                    Key</label><input type="password" id="mpwa-apikey" placeholder="API Key MPWA"><label>Template Masuk
                    ([nama], [waktu], [status])</label><textarea id="tpl-masuk" rows="2"></textarea><label>Template
                    Pulang</label><textarea id="tpl-pulang" rows="2"></textarea><label>Template Sakit / Ijin /
                    Alpha</label><textarea id="tpl-sakit" rows="1" placeholder="Sakit"></textarea><textarea
                    id="tpl-ijin" rows="1" placeholder="Ijin"></textarea><textarea id="tpl-alpha" rows="1"
                    placeholder="Alpha"></textarea><button onclick="saveMpwaSettingsUI()">Simpan Pengaturan
                    WA</button><button class="sec" onclick="testWA()">Test Kirim WA</button>
                <div id="mpwa-result" class="alert hidden"></div>
            </div>
            <div class="card card-orange">
                <h3><svg style="fill: #f59e0b; width: 20px; height: 20px; margin-right: 8px; vertical-align: middle;">
                        <use href="#icon-speaker" />
                    </svg>Pengaturan Suara (TTS)</h3>
                <label><input type="checkbox" id="tts-enabled" checked
                        style="width:auto;margin:0 6px 0 0;vertical-align:middle">Aktifkan Suara Penyebutan Nama</label>
                <p style="font-size:0.7rem;color:#666;margin-top:8px">Jika dimatikan, tidak ada suara saat scan
                    presensi. Proses scan menjadi lebih cepat.</p>
                <button onclick="saveTtsSettingsUI()">Simpan Pengaturan Suara</button>
                <div id="tts-result" class="alert hidden"></div>
            </div>
            <div class="card card-red">
                <h3><svg style="fill: #ef4444; width: 20px; height: 20px; margin-right: 8px; vertical-align: middle;">
                        <use href="#icon-lock" />
                    </svg>Ganti PIN Admin</h3><label>PIN Baru (6 Digit Angka)</label><input type="password" id="new-pin"
                    maxlength="6" placeholder="******" inputmode="numeric"><button onclick="savePinSetting()">Simpan
                    PIN</button>
                <div id="pin-result" class="alert hidden"></div>
            </div>
        </div>
        </div>

        <div class="print-report">
            <!-- Kop Surat Container -->
            <div id="print-kop" style="text-align:center;margin-bottom:20px;display:none;">
                <img id="print-kop-img" src="" style="width:100%;max-width:800px;height:auto;">
            </div>

            <h2 id="print-school" style="margin-top:0;">PRESENSI DIGITAL</h2>
            <div class="school">LAPORAN REKAPITULASI PRESENSI SISWA</div>
            <div class="info" id="print-filter"></div>
            <div class="info" id="print-date"></div>
            <table>
                <thead>
                    <tr>
                        <th>No</th>
                        <th>NIS</th>
                        <th>Nama</th>
                        <th>Kelas</th>
                        <th>H</th>
                        <th>S</th>
                        <th>I</th>
                        <th>A</th>
                        <th>T</th>
                        <th>Total</th>
                    </tr>
                </thead>
                <tbody id="print-tbody"></tbody>
            </table>

            <!-- Signature Footer -->
            <div class="signature-section" id="print-signature"
                style="margin-top:40px;display:flex;justify-content:space-between;page-break-inside:avoid;">
                <div style="text-align:center;width:250px;">
                    <div>Mengetahui,</div>
                    <div style="margin-bottom:60px;">Kepala Madrasah</div>
                    <div style="font-weight:bold;text-decoration:underline;" id="sig-kepsek-nama">
                        .........................</div>
                    <div id="sig-kepsek-nip">NIP. .........................</div>
                </div>
                <div style="text-align:center;width:250px;">
                    <div id="sig-date">Kota, Tanggal</div>
                    <div style="margin-bottom:60px;">Guru Kelas / Wali Kelas</div>
                    <div style="font-weight:bold;text-decoration:underline;" id="sig-guru-nama">
                        .........................</div>
                    <div id="sig-guru-nip">NIP. .........................</div>
                </div>
            </div>
        </div>

        <!-- Export Options Modal -->
        <div id="export-modal" class="modal">
            <style>
                .export-grid {
                    display: grid;
                    grid-template-columns: 1fr 1fr;
                    gap: 20px;
                    text-align: left;
                }

                .export-input {
                    width: 100%;
                    padding: 8px 12px;
                    border-radius: 8px;
                    border: 1px solid #e2e8f0;
                    font-family: var(--font-main);
                    font-size: 0.9rem;
                    letter-spacing: -0.01em;
                    transition: all 0.2s;
                    color: var(--text);
                }

                input[type="date"].export-input {
                    font-size: 0.8rem;
                    letter-spacing: normal;
                }

                .export-input:focus {
                    border-color: var(--primary);
                    outline: none;
                    box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
                }

                .export-input::placeholder {
                    color: #94a3b8;
                    font-weight: 400;
                    font-size: 0.85rem;
                }

                .signature-input-group {
                    background: var(--bg-secondary);
                    padding: 16px;
                    border-radius: 12px;
                    border: 1px solid var(--glass-border);
                }

                .signature-label {
                    font-weight: 600;
                    color: var(--text);
                    margin-bottom: 12px;
                    font-size: 0.9rem;
                    display: flex;
                    align-items: center;
                    gap: 6px;
                }

                .mobile-stack {
                    display: grid;
                    grid-template-columns: 2fr 1.5fr;
                    gap: 15px;
                }

                @media (max-width: 480px) {
                    .export-grid {
                        grid-template-columns: 1fr !important;
                    }

                    .mobile-stack {
                        grid-template-columns: 1fr !important;
                        gap: 10px;
                    }

                    .modal-content {
                        padding: 20px;
                        width: 90% !important;
                        max-width: 90% !important;
                        max-height: 90vh;
                        overflow-y: auto;
                    }
                }
            </style>

            <div class="modal-content" style="max-width:550px">
                <h3><svg style="width:20px;height:20px;margin-right:8px;vertical-align:middle">
                        <use href="#icon-settings" />
                    </svg>Opsi Export / Cetak</h3>
                <p style="margin-bottom:15px;color:#666;font-size:0.9rem">Lengkapi data untuk footer laporan.</p>

                <div class="export-grid">
                    <div style="grid-column: 1 / -1">
                        <div class="mobile-stack">
                            <div>
                                <label
                                    style="font-size:0.85rem;font-weight:500;color:var(--text-secondary);margin-bottom:6px;display:block">Jarak/Kota</label>
                                <input type="text" id="opt-kota" placeholder="Contoh: Malang" class="export-input">
                            </div>
                            <div>
                                <label
                                    style="font-size:0.85rem;font-weight:500;color:var(--text-secondary);margin-bottom:6px;display:block">Tanggal
                                    Cetak</label>
                                <input type="date" id="opt-tanggal" class="export-input">
                            </div>
                        </div>
                    </div>

                    <div class="signature-input-group">
                        <div class="signature-label">
                            <svg style="width:16px;height:16px;opacity:0.7">
                                <use href="#icon-users" />
                            </svg> Kepala Madrasah
                        </div>
                        <input type="text" id="opt-kepsek" placeholder="Nama Lengkap & Gelar" class="export-input"
                            style="margin-bottom:10px">
                        <input type="text" id="opt-kepsek-nip" placeholder="NIP (Opsional)" class="export-input"
                            style="font-size:0.8rem;opacity:0.9">
                    </div>

                    <div class="signature-input-group">
                        <div class="signature-label">
                            <svg style="width:16px;height:16px;opacity:0.7">
                                <use href="#icon-users" />
                            </svg> Guru / Wali Kelas
                        </div>
                        <input type="text" id="opt-guru" placeholder="Nama Lengkap & Gelar" class="export-input"
                            style="margin-bottom:10px">
                        <input type="text" id="opt-guru-nip" placeholder="NIP (Opsional)" class="export-input"
                            style="font-size:0.8rem;opacity:0.9">
                    </div>
                </div>

                <div class="modal-btns" style="margin-top:20px">
                    <button class="sec" onclick="closeExportModal()">Batal</button>
                    <button id="btn-confirm-export" onclick="processExport()">Lanjut Export</button>
                </div>
            </div>
        </div>

        <!-- Bottom Navigation Bar -->
        <div class="bottom-nav" id="bottom-nav">
            <div class="bottom-nav-items">
                <div class="nav-item active" onclick="switchToPage('home')">
                    <div class="nav-icon">
                        <svg>
                            <use href="#icon-home" />
                        </svg>
                    </div>
                    <div class="nav-label">Beranda</div>
                </div>
                <div class="nav-item" onclick="switchToPage('siswa')">
                    <div class="nav-icon">
                        <svg>
                            <use href="#icon-users" />
                        </svg>
                    </div>
                    <div class="nav-label">Siswa</div>
                </div>
                <div class="nav-item" onclick="switchToPage('presensi')">
                    <div class="nav-icon">
                        <svg>
                            <use href="#icon-list" />
                        </svg>
                    </div>
                    <div class="nav-label">Presensi</div>
                </div>
                <div class="nav-item" onclick="switchToPage('qr-generator')">
                    <div class="nav-icon">
                        <svg>
                            <use href="#icon-qr" />
                        </svg>
                    </div>
                    <div class="nav-label">QR Code</div>
                </div>
                <div class="nav-item" onclick="switchToPage('laporan')">
                    <div class="nav-icon">
                        <svg>
                            <use href="#icon-chart" />
                        </svg>
                    </div>
                    <div class="nav-label">Laporan</div>
                </div>
            </div>
        </div>

        <script>
            var scanner, currentSettings, selectedStudent, lastLaporanData, lastLaporanFilter;
            var days = ['senin', 'selasa', 'rabu', 'kamis', 'jumat', 'sabtu', 'minggu'];
            var dayLabels = ['Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat', 'Sabtu', 'Minggu'];
            var rekapChart;

            // Dark Mode Functions
            function toggleTheme() {
                var currentTheme = document.documentElement.getAttribute('data-theme');
                var newTheme = currentTheme === 'dark' ? 'light' : 'dark';

                document.documentElement.setAttribute('data-theme', newTheme);
                localStorage.setItem('theme', newTheme);

                console.log(' Theme switched to:', newTheme);
            }

            function loadTheme() {
                var savedTheme = localStorage.getItem('theme');

                // Auto detect system preference if no saved theme
                if (!savedTheme) {
                    var prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                    savedTheme = prefersDark ? 'dark' : 'light';
                }

                document.documentElement.setAttribute('data-theme', savedTheme);
                console.log(' Theme loaded:', savedTheme);
            }

            // Load theme immediately (before page render)
            loadTheme();

            // Keyboard shortcut for theme toggle (Ctrl/Cmd + Shift + D)
            document.addEventListener('keydown', function (e) {
                if ((e.ctrlKey || e.metaKey) && e.shiftKey && e.key === 'D') {
                    e.preventDefault();
                    toggleTheme();
                }
            });

            // Initialize bottom nav and dashboard
            function initApp() {
                document.body.classList.add('has-bottom-nav');
                document.getElementById('bottom-nav').classList.add('active');
                loadDashboardStats();
                loadRecentActivity();
                initLogoAnimations();

                // Auto refresh dashboard every 30 seconds when on home page
                setInterval(function () {
                    var homePage = document.getElementById('page-home');
                    if (homePage && homePage.classList.contains('active')) {
                        loadDashboardStats();
                        loadRecentActivity();
                    }
                }, 30000); // 30 seconds
            }

            // Initialize logo animations
            function initLogoAnimations() {
                console.log(' Initializing logo animations...');
                var logoIcon = document.getElementById('home-logo-container');

                if (!logoIcon) {
                    console.error('? Logo container not found!');
                    return;
                }

                console.log('? Logo container found');

                // Force entrance animation with inline style
                logoIcon.style.animation = 'logoEntrance 0.8s cubic-bezier(0.34, 1.56, 0.64, 1) forwards';

                // Add floating effect after entrance animation completes
                setTimeout(function () {
                    console.log(' Adding float animation');
                    logoIcon.style.animation = 'logoFloat 3s ease-in-out infinite';
                    logoIcon.classList.add('float');
                }, 900); // After entrance completes (800ms + 100ms buffer)

                // Click to rotate - remove old listener first
                var newLogoIcon = logoIcon.cloneNode(true);
                logoIcon.parentNode.replaceChild(newLogoIcon, logoIcon);
                logoIcon = document.getElementById('home-logo-container');

                logoIcon.addEventListener('click', function (e) {
                    e.preventDefault();
                    console.log(' Logo clicked - rotating');

                    var currentAnimation = this.style.animation;
                    this.style.animation = 'logoRotate 0.6s ease-in-out';

                    var self = this;
                    setTimeout(function () {
                        // Restore previous animation (float)
                        self.style.animation = currentAnimation || 'logoFloat 3s ease-in-out infinite';
                        console.log('? Rotate complete - restored float');
                    }, 600);
                });

                // Hover effect
                logoIcon.addEventListener('mouseenter', function () {
                    if (!this.classList.contains('rotating')) {
                        this.style.animation = 'logoPulse 1s ease-in-out infinite';
                    }
                });

                logoIcon.addEventListener('mouseleave', function () {
                    if (!this.classList.contains('rotating')) {
                        this.style.animation = 'logoFloat 3s ease-in-out infinite';
                    }
                });

                console.log('? Logo animations initialized successfully');
            }

            // Switch page with bottom nav
            function switchToPage(pageName) {
                // Update nav items
                var navItems = document.querySelectorAll('.nav-item');
                navItems.forEach(function (item) {
                    item.classList.remove('active');
                });

                // Find and activate current nav item
                var pageIndex = { 'home': 0, 'siswa': 1, 'presensi': 2, 'qr-generator': 3, 'laporan': 4 };
                if (pageIndex[pageName] !== undefined) {
                    navItems[pageIndex[pageName]].classList.add('active');
                }

                // Show bottom nav
                document.getElementById('bottom-nav').classList.add('active');

                // Navigate to page
                goTo(pageName);
            }

            // Load dashboard statistics
            function loadDashboardStats() {
                // Get total students
                google.script.run.withSuccessHandler(function (students) {
                    var total = students.length;
                    animateCounter('dash-total-siswa', 0, total, 1000);

                    // Get today's attendance
                    google.script.run.withSuccessHandler(function (presensi) {
                        var hadir = presensi.filter(function (p) { return p.status === 'Hadir'; }).length;
                        var belumHadir = total - presensi.length;
                        var persentase = total > 0 ? Math.round((hadir / total) * 100) : 0;

                        animateCounter('dash-hadir-hari-ini', 0, hadir, 1000);
                        animateCounter('dash-belum-hadir', 0, belumHadir, 1000);
                        animateCounter('dash-persentase', 0, persentase, 1000, '%');
                    }).getDataPresensi({});
                }).getDataSiswa({});
            }

            // Animate counter from start to end
            function animateCounter(elementId, start, end, duration, suffix) {
                suffix = suffix || '';
                var element = document.getElementById(elementId);
                if (!element) return;

                var range = end - start;
                var increment = range / (duration / 16); // 60fps
                var current = start;

                var timer = setInterval(function () {
                    current += increment;
                    if ((increment > 0 && current >= end) || (increment < 0 && current <= end)) {
                        current = end;
                        clearInterval(timer);
                    }
                    element.textContent = Math.round(current) + suffix;
                }, 16);
            }

            // Load recent activity
            function loadRecentActivity() {
                google.script.run.withSuccessHandler(function (presensi) {
                    var list = document.getElementById('recent-activity-list');
                    if (presensi.length === 0) {
                        list.innerHTML = '<div style="text-align:center;padding:20px;color:#999;font-size:0.8rem">Belum ada aktivitas hari ini</div>';
                        return;
                    }

                    var html = '';
                    var recent = presensi.slice(0, 5); // Show last 5
                    for (var i = 0; i < recent.length; i++) {
                        var p = recent[i];
                        var initial = p.nama.charAt(0).toUpperCase();
                        var statusClass = p.status === 'Hadir' ? 'badge-success' : (p.status === 'Alpha' ? 'badge-danger' : 'badge-warning');
                        var waktu = p.jamMasuk !== '-' ? p.jamMasuk : '';

                        html += '<div class="activity-item">';
                        html += '<div class="activity-avatar">' + initial + '</div>';
                        html += '<div class="activity-info">';
                        html += '<div class="activity-name">' + p.nama + '</div>';
                        html += '<div class="activity-time">' + waktu + '  ' + p.kelas + '</div>';
                        html += '</div>';
                        html += '<div class="activity-status ' + statusClass + '">' + p.status + '</div>';
                        html += '</div>';
                    }
                    list.innerHTML = html;
                }).getDataPresensi({});
            }

            function goTo(p) {
                if (p === 'scan' || p === 'manual' || p === 'siswa' || p === 'presensi' || p === 'laporan' || p === 'qr-generator' || p === 'settings') {
                    if (p === 'settings') {
                        openSettings();
                        return;
                    }
                }
                document.querySelectorAll('.page').forEach(function (el) { el.classList.remove('active'); });
                document.getElementById('page-' + p).classList.add('active');
                document.getElementById('menu-btn').classList.remove('hidden');

                // Show bottom nav for all pages
                document.getElementById('bottom-nav').classList.add('active');

                if (p === 'home') {
                    document.getElementById('menu-btn').classList.add('hidden');
                    loadDashboardStats();
                    loadRecentActivity();
                }
                if (p === 'scan') startCam(); else stopCam();
                if (p === 'siswa') loadDataSiswa();
                if (p === 'presensi') { document.getElementById('pres-tgl').valueAsDate = new Date(); loadDataPresensi(); }
                if (p === 'laporan') { var d = new Date(); d.setDate(1); document.getElementById('lap-dari').valueAsDate = d; document.getElementById('lap-sampai').valueAsDate = new Date(); loadSiswaDropdown(); loadLaporan(); }
                if (p === 'qr-generator') { loadKelasList(); initQRGenerator(); }

                // ENHANCEMENT: Announce page change untuk screen reader
                const pageNames = {
                    'home': 'Beranda',
                    'scan': 'Scan QR Code',
                    'manual': 'Presensi Manual',
                    'siswa': 'Data Siswa',
                    'presensi': 'Data Presensi',
                    'laporan': 'Laporan',
                    'qr-generator': 'Generator QR Code',
                    'settings': 'Pengaturan'
                };

                if (window.HadirQEnhancements) {
                    window.HadirQEnhancements.announcePageChange(pageNames[p] || p);
                }
            }


            function goHome() {
                goTo('home');
                // Show bottom nav again
                document.getElementById('bottom-nav').classList.add('active');
                // Update active nav item
                document.querySelectorAll('.nav-item').forEach(function (item) {
                    item.classList.remove('active');
                });
                document.querySelectorAll('.nav-item')[0].classList.add('active');
            }
            function openSettings() { document.getElementById('pin-modal').classList.add('active'); document.getElementById('pin-input').focus(); }
            function closePinModal() { document.getElementById('pin-modal').classList.remove('active'); document.getElementById('pin-input').value = ''; }
            function verifyPinAndOpen() {
                var pin = document.getElementById('pin-input').value;
                if (!pin) return;
                var btn = document.getElementById('pin-btn');
                var orig = btn.textContent;
                btn.disabled = true;
                btn.innerHTML = '<div class="spinner"></div>Verifikasi...';

                google.script.run.withSuccessHandler(function (res) {
                    btn.disabled = false;
                    btn.textContent = orig;
                    if (res && res.status === 'success') {
                        closePinModal();
                        document.querySelectorAll('.page').forEach(function (el) { el.classList.remove('active'); });
                        document.getElementById('page-settings').classList.add('active');
                        document.getElementById('menu-btn').classList.remove('hidden');
                        // Show bottom nav in settings (FIXED)
                        document.getElementById('bottom-nav').classList.add('active');
                        loadSettings();
                        loadMpwaSettings();
                    } else {
                        var e = document.getElementById('pin-error');
                        e.textContent = (res && res.message) ? res.message : 'PIN Salah!';
                        e.classList.remove('hidden');
                        setTimeout(function () { e.classList.add('hidden'); }, 2000);
                    }
                }).withFailureHandler(function (err) {
                    btn.disabled = false;
                    btn.textContent = orig;
                    var e = document.getElementById('pin-error');
                    e.textContent = 'Error: ' + err.message;
                    e.classList.remove('hidden');
                    setTimeout(function () { e.classList.add('hidden'); }, 2000);
                }).verifyPin(pin);
            }

            function beep() { try { var a = new AudioContext(); var o = a.createOscillator(); var g = a.createGain(); o.connect(g); g.connect(a.destination); o.type = 'sine'; o.frequency.value = 880; g.gain.setValueAtTime(0, a.currentTime); g.gain.linearRampToValueAtTime(0.2, a.currentTime + 0.05); g.gain.linearRampToValueAtTime(0, a.currentTime + 0.2); o.start(); o.stop(a.currentTime + 0.2); } catch (e) { } }
            function speak(t) { if (!ttsEnabled) return; if ('speechSynthesis' in window) { var s = new SpeechSynthesisUtterance(t); s.lang = 'id-ID'; s.rate = 1.1; window.speechSynthesis.speak(s); } }
            var ttsEnabled = true; // Default ON, loaded from settings

            // Audio MP3
            var audioSuccess = new Audio('https://mywa.pdmhadirq.my.id/storage/files/1/Terima Kasih.mp3');
            var audioDuplicate = new Audio('https://mywa.pdmhadirq.my.id/storage/files/1/Sudah Presensi.mp3');
            audioSuccess.volume = 0.8; audioDuplicate.volume = 0.8;
            function playSuccessAudio() { if (ttsEnabled) return; try { audioSuccess.currentTime = 0; audioSuccess.play().catch(function () { beep(); }); } catch (e) { beep(); } }
            function playDuplicateAudio() { if (ttsEnabled) return; try { audioDuplicate.currentTime = 0; audioDuplicate.play().catch(function () { beep(); }); } catch (e) { beep(); } }


            function loadKelasList() { google.script.run.withSuccessHandler(function (k) { var h = '<option value="">Kelas</option>'; for (var i = 0; i < k.length; i++) h += '<option value="' + k[i] + '">' + k[i] + '</option>'; document.getElementById('siswa-kelas').innerHTML = h; document.getElementById('pres-kelas').innerHTML = h; document.getElementById('lap-kelas').innerHTML = h.replace('Kelas', 'Semua Kelas'); document.getElementById('manual-kelas').innerHTML = h; if (document.getElementById('qr-kelas')) document.getElementById('qr-kelas').innerHTML = h.replace('Kelas', 'Pilih Kelas'); }).getKelasList(); }
            function loadSiswaDropdown() {
                var k = document.getElementById('lap-kelas').value;
                google.script.run
                    .withSuccessHandler(function (s) {
                        var h = '<option value="">Semua Siswa</option>';
                        for (var i = 0; i < s.length; i++) {
                            h += '<option value="' + s[i].nis + '">' + s[i].nama + ' (' + s[i].nis + '-' + s[i].kelas + ')</option>';
                        }
                        document.getElementById('lap-siswa').innerHTML = h;
                    })
                    .withFailureHandler(function (error) {
                        console.error('Error loading students:', error);
                    })
                    .getSiswaList(k);
            }

            function loadDataSiswa() {
                var tb = document.getElementById('siswa-tbody');

                // ENHANCEMENT: Show loading skeleton
                if (window.HadirQEnhancements) {
                    window.HadirQEnhancements.showLoadingSkeleton(tb, 5);
                } else {
                    tb.innerHTML = '<tr><td colspan="4" style="text-align:center"><div class="spinner"></div>Memuat...</td></tr>';
                }

                var f = {
                    kelas: document.getElementById('siswa-kelas').value,
                    nama: document.getElementById('siswa-nama').value
                };

                google.script.run
                    .withSuccessHandler(function (d) {
                        if (d.length === 0) {
                            // ENHANCEMENT: Show empty state
                            if (window.HadirQEnhancements) {
                                window.HadirQEnhancements.showEmptyState(tb, 'Tidak ada siswa yang ditemukan dengan kriteria pencarian');
                            } else {
                                tb.innerHTML = '<tr><td colspan="4" style="text-align:center;color:#999">Tidak ada data</td></tr>';
                            }
                            return;
                        }

                        // Render data
                        var h = '';
                        for (var i = 0; i < d.length; i++) {
                            h += '<tr><td>' + d[i].no + '</td><td>' + d[i].nis + '</td><td>' + d[i].nama + '</td><td>' + d[i].kelas + '</td></tr>';
                        }
                        tb.innerHTML = h;
                    })
                    .withFailureHandler(function (error) {
                        // ENHANCEMENT: Show error state
                        if (window.HadirQEnhancements) {
                            window.HadirQEnhancements.showErrorState(tb, 'Gagal memuat data siswa. Silakan coba lagi.');
                            window.HadirQEnhancements.showToast('Gagal memuat data siswa', 'error');
                        } else {
                            tb.innerHTML = '<tr><td colspan="4" style="text-align:center;color:#999">Gagal memuat data</td></tr>';
                        }
                    })
                    .getDataSiswa(f);
            }

            function processPresensi(data) {
                const btn = document.getElementById('submit-btn');

                // TAMBAHKAN: Button loading state
                if (window.HadirQEnhancements) {
                    window.HadirQEnhancements.setButtonLoading(btn, true);
                }

                google.script.run
                    .withSuccessHandler(function (result) {
                        // TAMBAHKAN: Remove loading & show toast
                        if (window.HadirQEnhancements) {
                            window.HadirQEnhancements.setButtonLoading(btn, false);
                            window.HadirQEnhancements.showToast(
                                result.message,
                                result.status === 'success' ? 'success' : 'warning'
                            );
                        }
                    })
                    .withFailureHandler(function (error) {
                        // TAMBAHKAN: Error handling
                        if (window.HadirQEnhancements) {
                            window.HadirQEnhancements.setButtonLoading(btn, false);
                            window.HadirQEnhancements.showToast('Terjadi kesalahan', 'error');
                        }
                    })
                    .processPresensi(data);
            }
            function loadLaporan() {
                var f = {
                    kelas: document.getElementById('lap-kelas').value,
                    siswa: document.getElementById('lap-siswa').value,
                    dariTgl: document.getElementById('lap-dari').value,
                    sampaiTgl: document.getElementById('lap-sampai').value
                };
                google.script.run
                    .withSuccessHandler(function (res) {
                        if (res.error) {
                            lastLaporanData = null;
                            lastLaporanFilter = null;
                            var el = document.getElementById('laporan-result');
                            el.className = 'alert alert-error';
                            el.textContent = 'Error: ' + res.error;
                            el.classList.remove('hidden');
                            return;
                        }
                        lastLaporanData = res;
                        lastLaporanFilter = Object.assign({}, f);
                        var el = document.getElementById('laporan-result');
                        el.classList.add('hidden');
                        var s = res.stats;
                        document.getElementById('stat-h').textContent = s.hadir;
                        document.getElementById('stat-s').textContent = s.sakit;
                        document.getElementById('stat-i').textContent = s.ijin;
                        document.getElementById('stat-a').textContent = s.alpha;
                        updateChart(s);
                    })
                    .withFailureHandler(function (err) {
                        lastLaporanData = null;
                        lastLaporanFilter = null;
                        var el = document.getElementById('laporan-result');
                        el.className = 'alert alert-error';
                        el.textContent = 'Gagal memuat data: ' + err.message;
                        el.classList.remove('hidden');
                    })
                    .getLaporanData(f);
            }
            function updateChart(s) { var ctx = document.getElementById('rekapChart').getContext('2d'); if (rekapChart) rekapChart.destroy(); rekapChart = new Chart(ctx, { type: 'doughnut', data: { labels: ['Hadir', 'Sakit', 'Ijin', 'Alpha'], datasets: [{ data: [s.hadir, s.sakit, s.ijin, s.alpha], backgroundColor: ['#06d6a0', '#f78c6b', '#ffd166', '#ef476f'], borderWidth: 0 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { boxWidth: 12, font: { size: 10 } } } }, cutout: '70%' } }); }

            var exportType = 'excel'; // 'excel' or 'pdf'

            function openExportModal(type) {
                exportType = type;
                document.getElementById('export-modal').classList.add('active');

                // Set default date
                document.getElementById('opt-tanggal').valueAsDate = new Date();

                // Load saved defaults if available (could be implemented later)
                // For now, try to use settings if they exist in global variable 'currentSettings'
                if (currentSettings) {
                    // document.getElementById('opt-kota').value = currentSettings.kota || '';
                }
            }

            function closeExportModal() {
                document.getElementById('export-modal').classList.remove('active');
            }

            function processExport() {
                closeExportModal();
                if (exportType === 'excel') {
                    runExportExcel();
                } else {
                    runPrintPDF();
                }
            }

            // Modified functions to trigger modal
            function exportExcel() {
                if (!lastLaporanData || !Array.isArray(lastLaporanData.data)) return alert('Muat data terlebih dahulu');
                openExportModal('excel');
            }

            function printPDF() {
                if (!lastLaporanData || !Array.isArray(lastLaporanData.data)) return alert('Muat data terlebih dahulu');
                openExportModal('pdf');
            }

            function runExportExcel() {
                var el = document.getElementById('export-result');
                el.className = 'alert';
                el.innerHTML = '<div class="spinner"></div>Membuat file...';
                el.classList.remove('hidden');

                var currentFilter = {
                    kelas: document.getElementById('lap-kelas').value,
                    siswa: document.getElementById('lap-siswa').value,
                    dariTgl: document.getElementById('lap-dari').value,
                    sampaiTgl: document.getElementById('lap-sampai').value
                };

                // Collect Signature Data
                var signatureData = {
                    kota: document.getElementById('opt-kota').value,
                    tanggal: formatDateIndo(document.getElementById('opt-tanggal').valueAsDate),
                    kepsekNama: document.getElementById('opt-kepsek').value,
                    kepsekNip: document.getElementById('opt-kepsek-nip').value,
                    guruNama: document.getElementById('opt-guru').value,
                    guruNip: document.getElementById('opt-guru-nip').value
                };

                // Export harus konsisten dengan data yang sedang tampil.
                if (!lastLaporanData || !Array.isArray(lastLaporanData.data)) {
                    el.className = 'alert alert-error';
                    el.textContent = 'Muat data laporan dulu, lalu klik Excel.';
                    setTimeout(function () { el.classList.add('hidden'); }, 5000);
                    return;
                }

                if (lastLaporanData.data.length === 0) {
                    el.className = 'alert alert-error';
                    el.textContent = 'Data laporan kosong untuk filter ini.';
                    setTimeout(function () { el.classList.add('hidden'); }, 5000);
                    return;
                }

                google.script.run
                    .withSuccessHandler(function (res) {
                        if (res.status === 'success') {
                            // Check for base64 content
                            if (res.base64) {
                                var link = document.createElement('a');
                                link.href = 'data:application/vnd.openxmlformats-officedocument.spreadsheetml.sheet;base64,' + res.base64;
                                link.download = res.fileName || 'Laporan_Presensi.xlsx';
                                document.body.appendChild(link);
                                link.click();
                                document.body.removeChild(link);

                                el.className = 'alert alert-success';
                                el.textContent = 'Download dimulai...';
                            } else if (res.url) {
                                // Fallback to URL if base64 is missing
                                el.className = 'alert alert-success';
                                el.innerHTML = 'Export berhasil! <a href="' + res.url + '" target="_blank" style="color:#155724;font-weight:600">Buka File</a>';
                                window.open(res.url, '_blank');
                            } else {
                                el.className = 'alert alert-success';
                                el.textContent = 'Export berhasil, namun file tidak dapat didownload otomatis.';
                            }
                        } else {
                            el.className = 'alert alert-error';
                            el.textContent = res.message;
                        }
                        setTimeout(function () { el.classList.add('hidden'); }, 5000);
                    })
                    .withFailureHandler(function (err) {
                        el.className = 'alert alert-error';
                        el.textContent = 'Gagal export: ' + err.message;
                        setTimeout(function () { el.classList.add('hidden'); }, 5000);
                    })
                    .exportPreparedLaporan(lastLaporanData, lastLaporanFilter || currentFilter, signatureData);
            }

            function formatTgl(val) { if (!val || val === '-') return '-'; var p = val.split('-'); return p.length === 3 ? p[2] + '-' + p[1] + '-' + p[0] : val; }
            function formatDateIndo(date) {
                if (!date) return '';
                var months = ['Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni', 'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'];
                return date.getDate() + ' ' + months[date.getMonth()] + ' ' + date.getFullYear();
            }

            function runPrintPDF() {
                if (!lastLaporanData || !Array.isArray(lastLaporanData.data)) return alert('Muat data terlebih dahulu');
                if (lastLaporanData.data.length === 0) return alert('Tidak ada data untuk dicetak');

                var d = lastLaporanData.data, st = lastLaporanData.stats;
                var school = document.getElementById('school-name-display').textContent;
                var dari = formatTgl((lastLaporanFilter && lastLaporanFilter.dariTgl) || document.getElementById('lap-dari').value) || '-';
                var sampai = formatTgl((lastLaporanFilter && lastLaporanFilter.sampaiTgl) || document.getElementById('lap-sampai').value) || '-';

                // Setup Kop Surat
                var kopUrl = (currentSettings && currentSettings.kopSuratUrl) ? currentSettings.kopSuratUrl : '';
                var fullKopUrl = idToLogoUrl(kopUrl);
                if (fullKopUrl) {
                    document.getElementById('print-kop-img').src = fullKopUrl;
                    document.getElementById('print-kop').style.display = 'block';
                    document.getElementById('print-school').style.display = 'none'; // Hide text title if kop exists
                } else {
                    document.getElementById('print-kop').style.display = 'none';
                    document.getElementById('print-school').style.display = 'block'; // Show text title
                }

                document.getElementById('print-school').textContent = school;
                document.getElementById('print-filter').innerHTML = '<strong>Periode Presensi:</strong> ' + dari + ' s/d ' + sampai;
                // document.getElementById('print-date').innerHTML = '<strong>Tanggal Cetak:</strong> ' + new Date().toLocaleString('id-ID'); // Removed in favor of footer

                var html = '';
                for (var i = 0; i < d.length; i++) {
                    html += '<tr><td>' + d[i].no + '</td><td>' + d[i].nis + '</td><td style="text-align:left">' + d[i].nama + '</td><td>' + d[i].kelas + '</td><td>' + d[i].hadir + '</td><td>' + d[i].sakit + '</td><td>' + d[i].ijin + '</td><td>' + d[i].alpha + '</td><td>' + (d[i].terlambat || 0) + '</td><td>' + d[i].total + '</td></tr>';
                }

                var total = st.hadir + st.sakit + st.ijin + st.alpha;
                html += '<tr class="total-row"><td></td><td></td><td style="text-align:left"><strong>TOTAL</strong></td><td></td><td>' + st.hadir + '</td><td>' + st.sakit + '</td><td>' + st.ijin + '</td><td>' + st.alpha + '</td><td>' + (st.terlambat || 0) + '</td><td>' + total + '</td></tr>';
                document.getElementById('print-tbody').innerHTML = html;

                // Setup Footer Signature
                var kota = document.getElementById('opt-kota').value || 'Kota';
                var tanggal = formatDateIndo(document.getElementById('opt-tanggal').valueAsDate) || '';
                var kepsek = document.getElementById('opt-kepsek').value || '.........................';
                var kepsekNip = document.getElementById('opt-kepsek-nip').value;
                var guru = document.getElementById('opt-guru').value || '.........................';
                var guruNip = document.getElementById('opt-guru-nip').value;

                document.getElementById('sig-date').textContent = kota + ', ' + tanggal;
                document.getElementById('sig-kepsek-nama').textContent = kepsek;
                document.getElementById('sig-kepsek-nip').textContent = kepsekNip ? 'NIP. ' + kepsekNip : 'NIP. .........................';
                document.getElementById('sig-guru-nama').textContent = guru;
                document.getElementById('sig-guru-nip').textContent = guruNip ? 'NIP. ' + guruNip : 'NIP. .........................';

                setTimeout(function () { window.print(); }, 100);
            }

            function loadAbsentStudents() {
                var tb = document.getElementById('absent-tbody');

                // ENHANCEMENT: Show loading skeleton
                if (window.HadirQEnhancements) {
                    window.HadirQEnhancements.showLoadingSkeleton(tb, 5);
                } else {
                    tb.innerHTML = '<tr><td colspan="4" style="text-align:center"><div class="spinner"></div>Memuat...</td></tr>';
                }

                var f = {
                    kelas: document.getElementById('manual-kelas').value,
                    nama: document.getElementById('manual-search').value
                };

                google.script.run
                    .withSuccessHandler(function (d) {
                        if (d.length === 0) {
                            // ENHANCEMENT: Show empty state (semua sudah presensi)
                            if (window.HadirQEnhancements) {
                                window.HadirQEnhancements.showEmptyState(tb, 'Semua siswa sudah melakukan presensi hari ini! ');
                            } else {
                                tb.innerHTML = '<tr><td colspan="4" style="text-align:center;color:#27ae60">Semua sudah presensi!</td></tr>';
                            }
                            return;
                        }

                        // Render data
                        var h = '';
                        for (var i = 0; i < d.length; i++) {
                            h += '<tr class="clickable" onclick="selectStudent(\'' + d[i].nis + '\',\'' + d[i].nama.replace(/'/g, "\\'") + '\',\'' + d[i].kelas + '\')"><td>' + d[i].no + '</td><td>' + d[i].nis + '</td><td>' + d[i].nama + '</td><td>' + d[i].kelas + '</td></tr>';
                        }
                        tb.innerHTML = h;
                    })
                    .withFailureHandler(function (error) {
                        // ENHANCEMENT: Show error state
                        if (window.HadirQEnhancements) {
                            window.HadirQEnhancements.showErrorState(tb, 'Gagal memuat daftar siswa. Silakan coba lagi.');
                            window.HadirQEnhancements.showToast('Gagal memuat daftar siswa', 'error');
                        } else {
                            tb.innerHTML = '<tr><td colspan="4" style="text-align:center;color:#999">Gagal memuat data</td></tr>';
                        }
                    })
                    .getAbsentStudents(f);

                document.getElementById('manual-form').classList.add('hidden');
                selectedStudent = null;
            }

            function selectStudent(nis, nama, kelas) { selectedStudent = { nis: nis, nama: nama, kelas: kelas }; document.getElementById('selected-student').innerHTML = '<strong>' + nama + '</strong><br>NIS: ' + nis + ' | Kelas: ' + kelas; document.getElementById('manual-form').classList.remove('hidden'); document.getElementById('m-status').value = 'Hadir'; document.getElementById('m-ket').value = ''; }
            function cancelManual() { document.getElementById('manual-form').classList.add('hidden'); selectedStudent = null; }

            function submitManualPresensi() {
                if (!selectedStudent) return;

                var btn = document.getElementById('m-btn');
                var r = document.getElementById('manual-result');
                var orig = btn.textContent;

                // ENHANCEMENT: Set button loading state
                if (window.HadirQEnhancements) {
                    window.HadirQEnhancements.setButtonLoading(btn, true);
                } else {
                    btn.disabled = true;
                    btn.innerHTML = '<div class="spinner"></div>Kirim...';
                }

                var data = {
                    nis: selectedStudent.nis,
                    status: document.getElementById('m-status').value,
                    keterangan: document.getElementById('m-ket').value || 'Manual'
                };

                google.script.run
                    .withSuccessHandler(function (res) {
                        // ENHANCEMENT: Remove button loading
                        if (window.HadirQEnhancements) {
                            window.HadirQEnhancements.setButtonLoading(btn, false);
                        } else {
                            btn.disabled = false;
                            btn.textContent = orig;
                        }

                        var nama = res.nama || selectedStudent.nama;
                        var nd = nama.split(' ')[0] || nama;
                        var ns = nd.replace(/[^a-zA-Z\s]/g, '');

                        if (res.status === 'duplicate') {
                            // ENHANCEMENT: Toast notification
                            if (window.HadirQEnhancements) {
                                window.HadirQEnhancements.showToast(res.message, 'warning');
                            }
                            r.className = 'alert alert-warning';
                            r.textContent = res.message;
                            playDuplicateAudio();
                            speak(ns + ' sudah absen');

                        } else if (res.status === 'error') {
                            // ENHANCEMENT: Toast notification
                            if (window.HadirQEnhancements) {
                                window.HadirQEnhancements.showToast(res.message, 'error');
                            }
                            r.className = 'alert alert-error';
                            r.textContent = res.message;
                        } else {
                            // ENHANCEMENT: Toast notification
                            if (window.HadirQEnhancements) {
                                window.HadirQEnhancements.showToast('? ' + res.message, 'success');
                            }
                            playSuccessAudio();
                            r.className = 'alert alert-success';
                            r.textContent = res.message;
                            speak(ns + ' ' + data.status.toLowerCase());
                            loadAbsentStudents();
                        }

                        r.classList.remove('hidden');

                        setTimeout(function () {
                            r.classList.add('hidden');
                        }, 3000);
                    })
                    .withFailureHandler(function (error) {
                        // ENHANCEMENT: Error handling
                        if (window.HadirQEnhancements) {
                            window.HadirQEnhancements.setButtonLoading(btn, false);
                            window.HadirQEnhancements.showToast('Terjadi kesalahan sistem', 'error');
                        } else {
                            btn.disabled = false;
                            btn.textContent = orig;
                        }

                        r.className = 'alert alert-error';
                        r.textContent = 'Terjadi kesalahan sistem. Silakan coba lagi.';
                        r.classList.remove('hidden');

                        setTimeout(function () {
                            r.classList.add('hidden');
                        }, 3000);
                    })
                    .processPresensi(data);
            }

            function send(d, ok, err) { google.script.run.withSuccessHandler(ok).withFailureHandler(err).processPresensi(d); }
            function hidePause() { setTimeout(function () { var divs = document.querySelectorAll('#reader > div'); for (var i = 0; i < divs.length; i++) { if (divs[i].textContent && divs[i].textContent.toLowerCase().indexOf('paused') >= 0) { divs[i].style.display = 'none'; } } }, 100); }
            function onScan(txt) { if (scanner) { scanner.pause(); hidePause(); } var r = document.getElementById('scan-result'), st = document.getElementById('scan-status'); st.textContent = 'Memproses...'; r.className = 'alert'; r.innerHTML = '<div class="spinner"></div>Proses...'; r.classList.remove('hidden'); send({ nis: txt, status: 'Hadir', keterangan: 'Scan' }, function (res) { var nama = res.nama || '', nd = nama.split(' ')[0] || nama, ns = nd.replace(/[^a-zA-Z\s]/g, ''); var tipeLabel = res.tipe ? '<span class="scan-tipe ' + res.tipe + '">' + res.tipe.toUpperCase() + '</span>' : ''; if (res.status === 'duplicate') { st.textContent = 'Sudah Absen'; r.className = 'alert alert-warning'; r.innerHTML = nama + ' sudah absen ' + tipeLabel; playDuplicateAudio(); speak(ns + ' sudah absen'); } else if (res.status === 'error') { st.textContent = 'Gagal'; r.className = 'alert alert-error'; r.textContent = res.message; speak(res.message.indexOf('belum') >= 0 ? ns + ' belum absen masuk' : 'nis tidak terdaftar'); } else { playSuccessAudio(); st.textContent = 'Sukses!'; r.className = 'alert alert-success'; r.innerHTML = res.message + tipeLabel; speak(ns + ' ' + (res.tipe || 'hadir')); } setTimeout(function () { r.classList.add('hidden'); st.textContent = 'Arahkan ke QR'; if (scanner) scanner.resume(); }, 1500); }, function (e) { st.textContent = 'Gagal'; r.className = 'alert alert-error'; r.textContent = e.message; setTimeout(function () { r.classList.add('hidden'); st.textContent = 'Arahkan ke QR'; if (scanner) scanner.resume(); }, 1500); }); }
            function startCam() { var s = document.getElementById('scan-status'); s.textContent = 'Izin kamera...'; if (!scanner) scanner = new Html5Qrcode('reader'); scanner.start({ facingMode: 'environment' }, { fps: 15, qrbox: { width: 200, height: 200 } }, onScan, function () { }).then(function () { s.textContent = 'Arahkan ke QR'; document.getElementById('start-btn').disabled = true; document.getElementById('stop-btn').disabled = false; document.getElementById('start-btn').classList.add('sec'); document.getElementById('stop-btn').classList.remove('sec'); document.getElementById('stop-btn').style.background = '#e74c3c'; document.getElementById('stop-btn').style.color = '#fff'; }).catch(function (e) { s.textContent = 'Gagal: ' + e; }); }
            function stopCam() { if (scanner) { scanner.stop().then(function () { document.getElementById('scan-status').textContent = 'Berhenti'; document.getElementById('start-btn').disabled = false; document.getElementById('stop-btn').disabled = true; document.getElementById('start-btn').classList.remove('sec'); document.getElementById('stop-btn').classList.add('sec'); document.getElementById('stop-btn').style.background = ''; document.getElementById('stop-btn').style.color = ''; }); } }

            function idToLogoUrl(input) { if (!input || !input.trim()) return ''; input = input.trim(); if (input.indexOf('http') === 0) return input; return 'https://lh3.googleusercontent.com/d/' + input; }
            function loadSettings() { google.script.run.withSuccessHandler(function (s) { currentSettings = s; document.getElementById('set-schoolname').value = s.schoolName || ''; document.getElementById('school-name-display').textContent = s.schoolName || 'PRESENSI DIGITAL MADRASAH'; document.getElementById('set-logourl').value = s.logoUrl || ''; updateLogoPreview(s.logoUrl); updateHomeLogo(s.logoUrl); document.getElementById('set-kopurl').value = s.kopSuratUrl || ''; updateKopPreview(s.kopSuratUrl); renderSchedule(s.schedule || {}); }).getSettings(); loadHolidays(); }

            function saveKopSuratUrlSetting() {
                var url = document.getElementById('set-kopurl').value;
                var btn = event.srcElement; var orig = btn.textContent; btn.disabled = true; btn.textContent = 'Simpan...';
                google.script.run.withSuccessHandler(function () {
                    btn.disabled = false; btn.textContent = orig;
                    var r = document.getElementById('logo-result');
                    r.className = 'alert alert-success'; r.textContent = 'Kop Surat tersimpan!'; r.classList.remove('hidden');
                    setTimeout(function () { r.classList.add('hidden'); }, 2000);
                    updateKopPreview(url);
                    if (currentSettings) currentSettings.kopSuratUrl = url;
                    // Also update home page logo if school logo is not set but kop is set? No, keep separate.
                }).withFailureHandler(function (err) {
                    btn.disabled = false; btn.textContent = orig;
                    var r = document.getElementById('logo-result');
                    r.className = 'alert alert-error'; r.textContent = 'Gagal: ' + err.message; r.classList.remove('hidden');
                }).saveKopSuratUrl(url);
            }

            function updateKopPreview(url) {
                var el = document.getElementById('kop-preview');
                var fullUrl = idToLogoUrl(url);
                if (fullUrl) {
                    el.innerHTML = '<img src="' + fullUrl + '" style="width:100%;height:100%;object-fit:contain">';
                } else {
                    el.innerHTML = '<span>No Kop</span>';
                }
            }
            function updateLogoPreview(input) { var prev = document.getElementById('logo-preview'); var url = idToLogoUrl(input); if (url) { prev.innerHTML = '<img src="' + url + '" onerror="this.parentElement.innerHTML=\'<span>Error</span>\'">'; } else { prev.innerHTML = '<span>No Logo</span>'; } }
            function updateHomeLogo(input) {
                var container = document.getElementById('home-logo-container');
                if (!container) return;

                var url = idToLogoUrl(input);

                // Preserve animation classes
                var hasFloat = container.classList.contains('float');
                var hasRotate = container.classList.contains('rotate');

                if (url) {
                    container.classList.add('custom-logo');
                    container.innerHTML = '<img src="' + url + '" onerror="this.parentElement.classList.remove(\'custom-logo\');this.outerHTML=\'<svg id=default-logo-icon><use href=#icon-clipboard/></svg>\'">';
                } else {
                    container.classList.remove('custom-logo');
                    container.innerHTML = '<svg id="default-logo-icon"><use href="#icon-clipboard"/></svg>';
                }

                // Re-apply animation classes
                if (hasFloat) container.classList.add('float');
                if (hasRotate) container.classList.add('rotate');

                // Re-initialize logo animations
                initLogoAnimations();
            }
            function renderSchedule(sch) { var html = ''; for (var i = 0; i < days.length; i++) { var d = days[i], l = dayLabels[i], sc = sch[d] || { aktif: true, masukAwal: '06:30', masukAkhir: '07:30', pulangAwal: '14:00', pulangAkhir: '15:00' }; var isAktif = sc.aktif !== false && sc.aktif !== 'false'; html += '<tr><td><input type="checkbox" id="sch-' + d + '-aktif" ' + (isAktif ? 'checked' : '') + ' style="width:auto;margin:0"></td><td style="font-weight:600">' + l + '</td><td><input type="time" class="time-input" id="sch-' + d + '-ma" value="' + sc.masukAwal + '"></td><td><input type="time" class="time-input" id="sch-' + d + '-mk" value="' + sc.masukAkhir + '"></td><td><input type="time" class="time-input" id="sch-' + d + '-pa" value="' + sc.pulangAwal + '"></td><td><input type="time" class="time-input" id="sch-' + d + '-pk" value="' + sc.pulangAkhir + '"></td></tr>'; } document.getElementById('schedule-tbody').innerHTML = html; }
            function saveScheduleSetting() { var sch = {}; for (var i = 0; i < days.length; i++) { var d = days[i]; sch[d] = { aktif: document.getElementById('sch-' + d + '-aktif').checked, masukAwal: document.getElementById('sch-' + d + '-ma').value, masukAkhir: document.getElementById('sch-' + d + '-mk').value, pulangAwal: document.getElementById('sch-' + d + '-pa').value, pulangAkhir: document.getElementById('sch-' + d + '-pk').value }; } google.script.run.withSuccessHandler(function () { var el = document.getElementById('schedule-result'); el.className = 'alert alert-success'; el.textContent = 'Jadwal disimpan!'; el.classList.remove('hidden'); setTimeout(function () { el.classList.add('hidden'); }, 2000); }).saveSchedule(sch); }
            function saveSchoolNameSetting() { var name = document.getElementById('set-schoolname').value; google.script.run.withSuccessHandler(function () { var el = document.getElementById('school-result'); el.className = 'alert alert-success'; el.textContent = 'Nama disimpan!'; el.classList.remove('hidden'); document.getElementById('school-name-display').textContent = name; setTimeout(function () { el.classList.add('hidden'); }, 2000); }).saveSchoolName(name); }
            function saveLogoUrlSetting() { var input = document.getElementById('set-logourl').value; google.script.run.withSuccessHandler(function () { var el = document.getElementById('logo-result'); el.className = 'alert alert-success'; el.textContent = 'Logo disimpan!'; el.classList.remove('hidden'); updateLogoPreview(input); updateHomeLogo(input); setTimeout(function () { el.classList.add('hidden'); }, 2000); }).saveLogoUrl(input); }
            function loadHolidays() { google.script.run.withSuccessHandler(function (h) { var tb = document.getElementById('holidays-tbody'), html = ''; if (h.length > 0) { for (var i = 0; i < h.length; i++) { html += '<tr><td>' + h[i].tanggal + '</td><td>' + h[i].keterangan + '</td><td><button class="del-btn" onclick="deleteHolidaySetting(\'' + h[i].tanggal + '\')">x</button></td></tr>'; } } else html = '<tr><td colspan="3" style="text-align:center;color:#999">Tidak ada</td></tr>'; tb.innerHTML = html; }).getHolidays(); }
            function addHolidaySetting() { var tgl = document.getElementById('holiday-date').value, desc = document.getElementById('holiday-desc').value; if (!tgl) { alert('Pilih tanggal!'); return; } google.script.run.withSuccessHandler(function () { loadHolidays(); document.getElementById('holiday-date').value = ''; document.getElementById('holiday-desc').value = ''; }).addHoliday(tgl, desc); }
            function deleteHolidaySetting(tgl) { if (confirm('Hapus ' + tgl + '?')) { google.script.run.withSuccessHandler(function () { loadHolidays(); }).deleteHoliday(tgl); } }
            function savePinSetting() { var newPin = document.getElementById('new-pin').value; google.script.run.withSuccessHandler(function (res) { var el = document.getElementById('pin-result'); if (res.status === 'success') { el.className = 'alert alert-success'; el.textContent = 'PIN diubah!'; document.getElementById('new-pin').value = ''; } else { el.className = 'alert alert-error'; el.textContent = res.message; } el.classList.remove('hidden'); setTimeout(function () { el.classList.add('hidden'); }, 2000); }).savePin(newPin); }
            document.getElementById('pin-input').addEventListener('keyup', function (e) { if (e.key === 'Enter') verifyPinAndOpen(); });
            document.getElementById('set-logourl').addEventListener('input', function () { updateLogoPreview(this.value); });

            // Initialize app
            initApp();
            loadKelasList();
            google.script.run.withSuccessHandler(function (s) { if (s) { if (s.schoolName) document.getElementById('school-name-display').textContent = s.schoolName; if (s.logoUrl) updateHomeLogo(s.logoUrl); } }).getSettings();

            function loadMpwaSettings() { google.script.run.withSuccessHandler(function (m) { if (document.getElementById('mpwa-enabled')) { document.getElementById('mpwa-enabled').checked = m.enabled || false; document.getElementById('mpwa-sender').value = m.sender || ''; document.getElementById('mpwa-url').value = m.waApiUrl || 'https://gateway.pdmhadirq.cloud/api/send-message'; document.getElementById('mpwa-apikey').value = m.apiKey || ''; document.getElementById('tpl-masuk').value = m.templateMasuk || ''; document.getElementById('tpl-pulang').value = m.templatePulang || ''; document.getElementById('tpl-sakit').value = m.templateSakit || ''; document.getElementById('tpl-ijin').value = m.templateIjin || ''; document.getElementById('tpl-alpha').value = m.templateAlpha || ''; } }).getMpwaSettings(); }
            function saveMpwaSettingsUI() { var data = { enabled: document.getElementById('mpwa-enabled').checked, sender: document.getElementById('mpwa-sender').value, waApiUrl: document.getElementById('mpwa-url').value, apiKey: document.getElementById('mpwa-apikey').value, templateMasuk: document.getElementById('tpl-masuk').value, templatePulang: document.getElementById('tpl-pulang').value, templateSakit: document.getElementById('tpl-sakit').value, templateIjin: document.getElementById('tpl-ijin').value, templateAlpha: document.getElementById('tpl-alpha').value }; var el = document.getElementById('mpwa-result'); el.className = 'alert'; el.innerHTML = 'Menyimpan...'; el.classList.remove('hidden'); google.script.run.withSuccessHandler(function (res) { el.className = res.status === 'success' ? 'alert alert-success' : 'alert alert-error'; el.textContent = res.status === 'success' ? 'Pengaturan WA disimpan!' : res.message; setTimeout(function () { el.classList.add('hidden'); }, 3000); }).saveMpwaSettings(data); }
            function testWA() { var number = prompt('Masukkan nomor WA untuk test:'); if (!number) return; var el = document.getElementById('mpwa-result'); el.className = 'alert'; el.innerHTML = 'Mengirim...'; el.classList.remove('hidden'); google.script.run.withSuccessHandler(function (res) { el.className = res.status === 'success' ? 'alert alert-success' : 'alert alert-error'; el.textContent = res.status === 'success' ? 'Test WA berhasil!' : 'Gagal: ' + res.message; setTimeout(function () { el.classList.add('hidden'); }, 5000); }).testSendWA(number, 'Test notifikasi dari HadirQ'); }
            function loadTtsSettings() { google.script.run.withSuccessHandler(function (t) { ttsEnabled = t.enabled !== false; if (document.getElementById('tts-enabled')) { document.getElementById('tts-enabled').checked = ttsEnabled; } }).getTtsSettings(); }
            function saveTtsSettingsUI() { var enabled = document.getElementById('tts-enabled').checked; ttsEnabled = enabled; var el = document.getElementById('tts-result'); el.className = 'alert'; el.innerHTML = 'Menyimpan...'; el.classList.remove('hidden'); google.script.run.withSuccessHandler(function (res) { el.className = res.status === 'success' ? 'alert alert-success' : 'alert alert-error'; el.textContent = res.status === 'success' ? 'Pengaturan Suara disimpan!' : res.message; setTimeout(function () { el.classList.add('hidden'); }, 3000); }).saveTtsSettings({ enabled: enabled }); }

            // ========== QR GENERATOR FUNCTIONS ==========

            function initQRGenerator() {
                // Reset form
                document.getElementById('qr-kelas').value = '';
                document.getElementById('qr-siswa').innerHTML = '<option value="">Pilih Siswa</option>';
                document.querySelector('input[name="qr-mode"][value="single"]').checked = true;
                toggleQRMode();
                clearQRDisplay();
            }

            function loadSiswaForQR() {
                var kelas = document.getElementById('qr-kelas').value;
                var siswaSelect = document.getElementById('qr-siswa');

                console.log('loadSiswaForQR called with kelas:', kelas); // Debug log

                siswaSelect.innerHTML = '<option value="">Pilih Siswa</option>';

                if (!kelas) {
                    console.log('No kelas selected, returning'); // Debug log
                    return;
                }

                // Show loading
                siswaSelect.innerHTML = '<option value="">Memuat siswa...</option>';
                siswaSelect.disabled = true;
                console.log('Calling getSiswaList with kelas:', kelas); // Debug log

                // Add timeout to prevent hanging
                var timeoutId = setTimeout(function () {
                    siswaSelect.innerHTML = '<option value="">Timeout - coba lagi</option>';
                    siswaSelect.disabled = false;
                    console.error('Timeout loading siswa for kelas:', kelas);
                }, 10000); // 10 second timeout

                google.script.run.withSuccessHandler(function (siswa) {
                    clearTimeout(timeoutId); // Clear timeout on success
                    console.log('Received siswa data:', siswa); // Debug log
                    siswaSelect.disabled = false;
                    siswaSelect.innerHTML = '<option value="">Pilih Siswa</option>';

                    if (siswa && siswa.length > 0) {
                        for (var i = 0; i < siswa.length; i++) {
                            var option = document.createElement('option');
                            option.value = siswa[i].nis;
                            option.textContent = siswa[i].nama + ' (' + siswa[i].nis + ')';
                            siswaSelect.appendChild(option);
                        }
                        console.log('Added ' + siswa.length + ' students to dropdown'); // Debug log
                    } else {
                        siswaSelect.innerHTML = '<option value="">Tidak ada siswa di kelas ini</option>';
                        console.log('No students found for class:', kelas); // Debug log
                    }
                }).withFailureHandler(function (error) {
                    clearTimeout(timeoutId); // Clear timeout on error
                    siswaSelect.disabled = false;
                    siswaSelect.innerHTML = '<option value="">Error: ' + error.message + '</option>';
                    console.error('Error loading siswa:', error);

                    // Retry option
                    setTimeout(function () {
                        siswaSelect.innerHTML = '<option value="">Klik untuk retry</option>';
                    }, 3000);
                }).getSiswaList(kelas);
            }

            function toggleQRMode() {
                var mode = document.querySelector('input[name="qr-mode"]:checked').value;
                var siswaSelect = document.getElementById('qr-siswa');
                var downloadAllBtn = document.getElementById('download-all-btn');

                if (mode === 'batch') {
                    siswaSelect.disabled = true;
                    siswaSelect.style.opacity = '0.5';
                    downloadAllBtn.style.display = 'inline-block';
                } else {
                    siswaSelect.disabled = false;
                    siswaSelect.style.opacity = '1';
                    downloadAllBtn.style.display = 'none';
                }
            }

            function generateQRCode() {
                var mode = document.querySelector('input[name="qr-mode"]:checked').value;
                var kelas = document.getElementById('qr-kelas').value;
                var siswa = document.getElementById('qr-siswa').value;
                var resultEl = document.getElementById('qr-result');

                console.log('Generate QR - Mode:', mode, 'Kelas:', kelas, 'Siswa:', siswa); // Debug log

                // Validation
                if (!kelas) {
                    showQRResult('error', 'Pilih kelas terlebih dahulu!');
                    return;
                }

                if (mode === 'single' && !siswa) {
                    showQRResult('error', 'Pilih siswa terlebih dahulu!');
                    return;
                }

                // Show loading
                showQRResult('', '<div class="spinner"></div>Generating QR Code...');

                // Add timeout for QR generation
                var timeoutId = setTimeout(function () {
                    showQRResult('error', 'Timeout - proses terlalu lama, coba lagi');
                    console.error('Timeout generating QR code');
                }, 15000); // 15 second timeout

                // Use existing working functions instead of new ones
                if (mode === 'single') {
                    // Get single student data using getSiswaList
                    google.script.run.withSuccessHandler(function (students) {
                        clearTimeout(timeoutId);
                        console.log('Single student data:', students); // Debug log

                        if (students && students.length > 0) {
                            var student = students.find(function (s) { return s.nis === siswa; });
                            if (student) {
                                displayQRCards([student]);
                                showQRResult('success', 'QR Code berhasil dibuat!');
                            } else {
                                showQRResult('error', 'Siswa tidak ditemukan!');
                            }
                        } else {
                            showQRResult('error', 'Data siswa tidak ditemukan!');
                        }
                    }).withFailureHandler(function (error) {
                        clearTimeout(timeoutId);
                        console.error('Single QR error:', error); // Debug log
                        showQRResult('error', 'Error: ' + error.message);
                    }).getSiswaList(kelas);
                } else {
                    // Get all students in class using getSiswaList
                    google.script.run.withSuccessHandler(function (students) {
                        clearTimeout(timeoutId);
                        console.log('Batch students data:', students); // Debug log

                        if (students && students.length > 0) {
                            displayQRCards(students);
                            showQRResult('success', 'QR Code untuk ' + students.length + ' siswa berhasil dibuat!');
                        } else {
                            showQRResult('error', 'Tidak ada siswa ditemukan di kelas ' + kelas);
                        }
                    }).withFailureHandler(function (error) {
                        clearTimeout(timeoutId);
                        console.error('Batch QR error:', error); // Debug log
                        showQRResult('error', 'Error: ' + error.message);
                    }).getSiswaList(kelas);
                }
            }

            function showQRResult(type, message) {
                var el = document.getElementById('qr-result');
                el.className = 'alert' + (type ? ' alert-' + type : '');
                el.innerHTML = message;
                el.classList.remove('hidden');

                if (type) {
                    setTimeout(function () {
                        el.classList.add('hidden');
                    }, 3000);
                }
            }

            function displayQRCards(students) {
                var container = document.getElementById('qr-cards-container');
                var displayArea = document.getElementById('qr-display-area');

                container.innerHTML = '';

                for (var i = 0; i < students.length; i++) {
                    var student = students[i];
                    var card = createQRCard(student);
                    container.appendChild(card);
                }

                displayArea.classList.remove('hidden');
                displayArea.scrollIntoView({ behavior: 'smooth' });
            }

            function createQRCard(student) {
                var card = document.createElement('div');
                card.className = 'qr-card card-indigo';

                // Ensure we have the required data
                var nis = student.nis || '';
                var nama = student.nama || '';
                var kelas = student.kelas || '';

                card.innerHTML =
                    '<div class="student-info">' +
                    '<div class="student-name">' + nama + '</div>' +
                    '<div class="student-details">NIS: ' + nis + '</div>' +
                    '<div class="student-details">Kelas: ' + kelas + '</div>' +
                    '</div>' +
                    '<div class="qr-code" id="qr-' + nis + '"></div>' +
                    '<div class="qr-actions">' +
                    '<button onclick="downloadQR(\'' + nis + '\', \'' + nama.replace(/'/g, "\\'") + '\')">' +
                    '<svg style="width:12px;height:12px;fill:#fff;margin-right:4px"><use href="#icon-download"/></svg>' +
                    'Download' +
                    '</button>' +
                    '<button class="sec" onclick="printQR(\'' + nis + '\')">' +
                    '<svg style="width:12px;height:12px;fill:var(--text);margin-right:4px"><use href="#icon-print"/></svg>' +
                    'Print' +
                    '</button>' +
                    '</div>';

                // Generate QR Code using Google Charts API
                setTimeout(function () {
                    generateQRImage(nis, 'qr-' + nis);
                }, 100);

                return card;
            }

            function generateQRImage(nis, containerId) {
                // Using QR Server API (more reliable than Google Charts)
                var qrUrl = 'https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=' + encodeURIComponent(nis);
                var img = document.createElement('img');
                img.src = qrUrl;
                img.alt = 'QR Code for NIS: ' + nis;
                img.style.maxWidth = '150px';
                img.style.height = 'auto';
                img.style.border = '1px solid #ddd';
                img.style.borderRadius = '8px';

                // Add error handling for image loading
                img.onerror = function () {
                    console.error('Failed to load QR code for NIS:', nis);
                    // Fallback: create a simple text-based QR placeholder
                    var container = document.getElementById(containerId);
                    if (container) {
                        container.innerHTML = '<div style="width:150px;height:150px;border:2px dashed #ccc;display:flex;align-items:center;justify-content:center;text-align:center;font-size:12px;color:#666;border-radius:8px;">QR Code<br>NIS: ' + nis + '</div>';
                    }
                };

                img.onload = function () {
                    console.log('QR code loaded successfully for NIS:', nis);
                };

                var container = document.getElementById(containerId);
                if (container) {
                    container.innerHTML = ''; // Clear any existing content
                    container.appendChild(img);
                }
            }

            function downloadQR(nis, nama) {
                console.log('Downloading QR for:', nis, nama);

                // Use QR Server API for download (higher resolution)
                var qrUrl = 'https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=' + encodeURIComponent(nis);

                // Create a temporary canvas to convert the image
                var canvas = document.createElement('canvas');
                var ctx = canvas.getContext('2d');
                var img = new Image();

                img.crossOrigin = 'anonymous'; // Handle CORS
                img.onload = function () {
                    canvas.width = img.width;
                    canvas.height = img.height;
                    ctx.drawImage(img, 0, 0);

                    // Convert canvas to blob and download
                    canvas.toBlob(function (blob) {
                        var url = URL.createObjectURL(blob);
                        var link = document.createElement('a');
                        link.href = url;
                        link.download = 'QR_' + nama.replace(/\s+/g, '_') + '_' + nis + '.png';
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        URL.revokeObjectURL(url);
                        console.log('Download completed for:', nama);
                    }, 'image/png');
                };

                img.onerror = function () {
                    console.error('Failed to load image for download');
                    // Fallback: direct link download
                    var link = document.createElement('a');
                    link.href = qrUrl;
                    link.download = 'QR_' + nama.replace(/\s+/g, '_') + '_' + nis + '.png';
                    link.target = '_blank';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                };

                img.src = qrUrl;
            }

            function printQR(nis) {
                console.log('Printing QR for NIS:', nis);

                // Use QR Server API for printing (high resolution)
                var qrUrl = 'https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=' + encodeURIComponent(nis);

                // Find student name from the card
                var studentName = '';
                var cards = document.querySelectorAll('.qr-card');
                for (var i = 0; i < cards.length; i++) {
                    var cardNis = cards[i].querySelector('.student-details').textContent.replace('NIS: ', '');
                    if (cardNis === nis) {
                        studentName = cards[i].querySelector('.student-name').textContent;
                        break;
                    }
                }

                var printWindow = window.open('', '_blank');
                printWindow.document.write(
                    '<html><head><title>Print QR Code</title>' +
                    '<style>body{font-family:Arial,sans-serif;text-align:center;padding:20px;}' +
                    'h3{margin-bottom:10px;}img{max-width:300px;border:1px solid #ddd;}</style>' +
                    '</head><body>' +
                    '<h3>QR Code - ' + studentName + '</h3>' +
                    '<p>NIS: ' + nis + '</p>' +
                    '<img src="' + qrUrl + '" alt="QR Code" onload="window.print();" onerror="alert(\'Gagal memuat QR Code untuk print\');">' +
                    '</body></html>'
                );
                printWindow.document.close();

                // Auto close after printing
                setTimeout(function () {
                    printWindow.close();
                }, 1000);
            }

            function downloadAllQR() {
                var cards = document.querySelectorAll('.qr-card');
                if (cards.length === 0) {
                    showQRResult('error', 'Tidak ada QR Code untuk didownload!');
                    return;
                }

                showQRResult('', 'Mempersiapkan download...');
                console.log('Starting batch download for', cards.length, 'QR codes');

                var completed = 0;
                var total = cards.length;

                // Download each QR code with delay
                for (var i = 0; i < cards.length; i++) {
                    (function (index) {
                        setTimeout(function () {
                            var card = cards[index];
                            var studentName = card.querySelector('.student-name').textContent;
                            var studentNIS = card.querySelector('.student-details').textContent.replace('NIS: ', '');

                            console.log('Downloading QR', (index + 1), 'of', total, ':', studentName);

                            // Use the improved download function
                            downloadQR(studentNIS, studentName);

                            completed++;
                            if (completed === total) {
                                showQRResult('success', 'Semua QR Code (' + total + ') berhasil didownload!');
                            } else {
                                showQRResult('', 'Download progress: ' + completed + '/' + total);
                            }
                        }, index * 1000); // Delay 1 second between downloads
                    })(i);
                }
            }

            function clearQRDisplay() {
                document.getElementById('qr-display-area').classList.add('hidden');
                document.getElementById('qr-cards-container').innerHTML = '';
            }

            // Loading Page Functions
            function showLoading(message = 'Memuat...') {
                const loadingOverlay = document.getElementById('loading-overlay');
                const loadingSubtitle = loadingOverlay.querySelector('.loading-subtitle');
                const progressBar = loadingOverlay.querySelector('.loading-progress-bar');

                loadingSubtitle.textContent = message;
                loadingOverlay.classList.remove('hidden');

                // Reset progress animation
                progressBar.style.animation = 'none';
                setTimeout(() => {
                    progressBar.style.animation = 'progressLoad 2s ease-out forwards';
                }, 100);
            }

            function hideLoading() {
                const loadingOverlay = document.getElementById('loading-overlay');
                loadingOverlay.classList.add('hidden');
            }

            // Initialize loading page on app start
            document.addEventListener('DOMContentLoaded', function () {
                // Show initial loading
                showLoading('Inisialisasi Aplikasi...');

                // Hide loading after 2.5 seconds
                setTimeout(() => {
                    hideLoading();
                    loadDashboardStats();
                    loadRecentActivity();
                }, 2500);
            });

            // Enhanced loading for async operations
            function withLoading(promise, message) {
                showLoading(message);
                return promise.finally(() => {
                    setTimeout(hideLoading, 500);
                });
            }

            /**
             * HADIRQ DASHBOARD ENHANCEMENTS
             * Version: 1.0
             * Tanpa mengubah fungsionalitas existing
             */

            // ========== 1. ACCESSIBILITY ENHANCEMENTS ==========

            /**
             * Announce page changes to screen readers
             * @param {string} pageName - Nama halaman yang diakses
             */
            function announcePageChange(pageName) {
                const announcement = document.createElement('div');
                announcement.setAttribute('role', 'status');
                announcement.setAttribute('aria-live', 'polite');
                announcement.className = 'sr-only';
                announcement.textContent = `Navigasi ke halaman ${pageName}`;
                document.body.appendChild(announcement);

                setTimeout(() => {
                    announcement.remove();
                }, 1000);
            }

            /**
             * Add ARIA labels to interactive elements
             */
            function enhanceAccessibility() {
                // Add aria-label to buttons without text
                document.querySelectorAll('button:not([aria-label])').forEach(btn => {
                    const svg = btn.querySelector('svg use');
                    if (svg) {
                        const iconId = svg.getAttribute('href').replace('#icon-', '');
                        btn.setAttribute('aria-label', `Tombol ${iconId}`);
                    }
                });

                // Add role to tables
                document.querySelectorAll('table').forEach(table => {
                    if (!table.getAttribute('role')) {
                        table.setAttribute('role', 'table');
                    }
                });

                // Add aria-busy to loading states
                document.querySelectorAll('.spinner').forEach(spinner => {
                    const parent = spinner.closest('button, div');
                    if (parent) {
                        parent.setAttribute('aria-busy', 'true');
                    }
                });
            }

            // ========== 2. PERFORMANCE ENHANCEMENTS ==========

            /**
             * Lazy load images using Intersection Observer
             */
            function lazyLoadImages() {
                const images = document.querySelectorAll('img[loading="lazy"]');

                if ('IntersectionObserver' in window) {
                    const imageObserver = new IntersectionObserver((entries, observer) => {
                        entries.forEach(entry => {
                            if (entry.isIntersecting) {
                                const img = entry.target;
                                img.src = img.dataset.src || img.src;
                                img.classList.add('loaded');
                                observer.unobserve(img);
                            }
                        });
                    }, {
                        rootMargin: '50px'
                    });

                    images.forEach(img => imageObserver.observe(img));
                } else {
                    // Fallback for browsers without IntersectionObserver
                    images.forEach(img => {
                        img.src = img.dataset.src || img.src;
                        img.classList.add('loaded');
                    });
                }
            }

            /**
             * Debounce function for search inputs
             * @param {Function} func - Function to debounce
             * @param {number} wait - Wait time in milliseconds
             * @returns {Function} Debounced function
             */
            function debounce(func, wait = 300) {
                let timeout;
                return function executedFunction(...args) {
                    const later = () => {
                        clearTimeout(timeout);
                        func(...args);
                    };
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                };
            }

            /**
             * Throttle function for scroll events
             * @param {Function} func - Function to throttle
             * @param {number} limit - Limit time in milliseconds
             * @returns {Function} Throttled function
             */
            function throttle(func, limit = 100) {
                let inThrottle;
                return function (...args) {
                    if (!inThrottle) {
                        func.apply(this, args);
                        inThrottle = true;
                        setTimeout(() => inThrottle = false, limit);
                    }
                };
            }

            // ========== 3. UX ENHANCEMENTS ==========

            /**
             * Show toast notification
             * @param {string} message - Message to display
             * @param {string} type - Type: success, error, warning, info
             * @param {number} duration - Duration in milliseconds
             */
            function showToast(message, type = 'success', duration = 3000) {
                const toast = document.getElementById('toast');
                if (!toast) {
                    console.warn('Toast element not found');
                    return;
                }

                toast.textContent = message;
                toast.className = `toast ${type}`;
                toast.classList.add('show');

                // Auto hide
                setTimeout(() => {
                    toast.classList.remove('show');
                }, duration);
            }

            /**
             * Show empty state in container
             * @param {HTMLElement} container - Container element
             * @param {string} message - Message to display
             * @param {string} iconId - Icon ID (optional)
             */
            function showEmptyState(container, message, iconId = 'search') {
                if (!container) return;

                container.innerHTML = `
        <div class="empty-state" role="status">
            <svg aria-hidden="true">
                <use href="#icon-${iconId}" />
            </svg>
            <h4>Tidak Ada Data</h4>
            <p>${message}</p>
        </div>
    `;
            }

            /**
             * Show error state in container
             * @param {HTMLElement} container - Container element
             * @param {string} message - Error message
             */
            function showErrorState(container, message) {
                if (!container) return;

                container.innerHTML = `
        <div class="error-state" role="alert">
            <svg aria-hidden="true">
                <use href="#icon-refresh" />
            </svg>
            <h4>Terjadi Kesalahan</h4>
            <p>${message}</p>
            <button onclick="location.reload()" aria-label="Muat ulang halaman">
                Muat Ulang
            </button>
        </div>
    `;
            }

            /**
             * Show loading skeleton in container
             * @param {HTMLElement} container - Container element
             * @param {number} rows - Number of skeleton rows
             */
            function showLoadingSkeleton(container, rows = 3) {
                if (!container) return;

                const skeletons = Array(rows).fill(0).map(() =>
                    '<div class="skeleton" style="height: 40px; margin-bottom: 8px;"></div>'
                ).join('');

                container.innerHTML = `<div role="status" aria-label="Memuat data">${skeletons}</div>`;
            }

            // ========== 4. PULL TO REFRESH ==========

            let touchStartY = 0;
            let touchEndY = 0;
            let isPulling = false;

            /**
             * Initialize pull to refresh functionality
             */
            function initPullToRefresh() {
                const indicator = document.getElementById('pull-to-refresh');
                if (!indicator) return;

                document.addEventListener('touchstart', (e) => {
                    touchStartY = e.touches[0].clientY;
                }, { passive: true });

                document.addEventListener('touchmove', (e) => {
                    touchEndY = e.touches[0].clientY;
                    const pullDistance = touchEndY - touchStartY;

                    // Only trigger if at top of page
                    if (pullDistance > 100 && window.scrollY === 0 && !isPulling) {
                        indicator.classList.add('active');
                        isPulling = true;
                    }
                }, { passive: true });

                document.addEventListener('touchend', () => {
                    const pullDistance = touchEndY - touchStartY;

                    if (pullDistance > 100 && window.scrollY === 0 && isPulling) {
                        showToast('Memuat ulang...', 'info', 1000);
                        setTimeout(() => {
                            location.reload();
                        }, 500);
                    }

                    indicator.classList.remove('active');
                    isPulling = false;
                    touchStartY = 0;
                    touchEndY = 0;
                }, { passive: true });
            }

            // ========== 5. OFFLINE/ONLINE DETECTION ==========

            /**
             * Initialize offline/online detection
             */
            function initOfflineDetection() {
                const indicator = document.getElementById('offline-indicator');
                if (!indicator) return;

                window.addEventListener('online', () => {
                    indicator.classList.remove('show');
                    showToast('Koneksi internet tersambung kembali', 'success');
                });

                window.addEventListener('offline', () => {
                    indicator.classList.add('show');
                    showToast('Tidak ada koneksi internet', 'error', 5000);
                });

                // Check initial status
                if (!navigator.onLine) {
                    indicator.classList.add('show');
                }
            }

            // ========== 6. KEYBOARD NAVIGATION ==========

            /**
             * Enhance keyboard navigation
             */
            function enhanceKeyboardNavigation() {
                // Escape key to close modals
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') {
                        const modal = document.querySelector('.modal.active');
                        if (modal) {
                            const closeBtn = modal.querySelector('button.sec');
                            if (closeBtn) closeBtn.click();
                        }
                    }
                });

                // Arrow keys for navigation items
                const navItems = document.querySelectorAll('.nav-item');
                navItems.forEach((item, index) => {
                    item.addEventListener('keydown', (e) => {
                        if (e.key === 'ArrowRight') {
                            e.preventDefault();
                            const next = navItems[index + 1] || navItems[0];
                            next.focus();
                        } else if (e.key === 'ArrowLeft') {
                            e.preventDefault();
                            const prev = navItems[index - 1] || navItems[navItems.length - 1];
                            prev.focus();
                        }
                    });
                });
            }

            // ========== 7. FORM VALIDATION ==========

            /**
             * Add real-time form validation
             * @param {HTMLFormElement} form - Form element
             */
            function enhanceFormValidation(form) {
                if (!form) return;

                const inputs = form.querySelectorAll('input[required], select[required], textarea[required]');

                inputs.forEach(input => {
                    input.addEventListener('blur', () => {
                        if (!input.validity.valid) {
                            input.setAttribute('aria-invalid', 'true');
                            input.style.borderColor = 'var(--danger)';
                        } else {
                            input.removeAttribute('aria-invalid');
                            input.style.borderColor = '';
                        }
                    });

                    input.addEventListener('input', () => {
                        if (input.validity.valid) {
                            input.removeAttribute('aria-invalid');
                            input.style.borderColor = '';
                        }
                    });
                });
            }

            // ========== 8. BUTTON LOADING STATE ==========

            /**
             * Add loading state to button
             * @param {HTMLButtonElement} button - Button element
             * @param {boolean} loading - Loading state
             */
            function setButtonLoading(button, loading) {
                if (!button) return;

                if (loading) {
                    button.setAttribute('aria-busy', 'true');
                    button.disabled = true;
                    button.dataset.originalText = button.textContent;
                } else {
                    button.removeAttribute('aria-busy');
                    button.disabled = false;
                    if (button.dataset.originalText) {
                        button.textContent = button.dataset.originalText;
                    }
                }
            }

            // ========== 9. LOCAL STORAGE HELPERS ==========

            /**
             * Save to local storage with error handling
             * @param {string} key - Storage key
             * @param {any} value - Value to store
             */
            function saveToStorage(key, value) {
                try {
                    localStorage.setItem(key, JSON.stringify(value));
                    return true;
                } catch (error) {
                    console.error('Error saving to storage:', error);
                    return false;
                }
            }

            /**
             * Load from local storage with error handling
             * @param {string} key - Storage key
             * @param {any} defaultValue - Default value if not found
             * @returns {any} Stored value or default
             */
            function loadFromStorage(key, defaultValue = null) {
                try {
                    const item = localStorage.getItem(key);
                    return item ? JSON.parse(item) : defaultValue;
                } catch (error) {
                    console.error('Error loading from storage:', error);
                    return defaultValue;
                }
            }

            // ========== 10. INITIALIZATION ==========

            /**
             * Initialize all enhancements
             */
            function initEnhancements() {
                console.log(' Initializing HadirQ enhancements...');

                // Accessibility
                enhanceAccessibility();
                enhanceKeyboardNavigation();

                // Performance
                lazyLoadImages();

                // UX
                initPullToRefresh();
                initOfflineDetection();

                // Forms
                document.querySelectorAll('form').forEach(form => {
                    enhanceFormValidation(form);
                });

                // Add debounced search to all search inputs
                document.querySelectorAll('input[type="text"][placeholder*="Cari"]').forEach(input => {
                    const originalHandler = input.onkeyup;
                    if (originalHandler) {
                        input.onkeyup = debounce(originalHandler, 300);
                    }
                });

                console.log(' Enhancements initialized successfully');
            }

            // Auto-initialize when DOM is ready
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', initEnhancements);
            } else {
                initEnhancements();
            }

            // Export functions for use in other scripts
            window.HadirQEnhancements = {
                announcePageChange,
                showToast,
                showEmptyState,
                showErrorState,
                showLoadingSkeleton,
                setButtonLoading,
                debounce,
                throttle,
                saveToStorage,
                loadFromStorage
            };

            document.addEventListener('DOMContentLoaded', function () {
                // Debounce untuk search siswa
                var siswaSearch = document.getElementById('siswa-nama');
                if (siswaSearch && window.HadirQEnhancements) {
                    var debouncedSiswaSearch = window.HadirQEnhancements.debounce(loadDataSiswa, 300);
                    siswaSearch.addEventListener('input', debouncedSiswaSearch);
                    // Remove onkeyup attribute jika ada
                    siswaSearch.removeAttribute('onkeyup');
                }

                // Debounce untuk search manual
                var manualSearch = document.getElementById('manual-search');
                if (manualSearch && window.HadirQEnhancements) {
                    var debouncedManualSearch = window.HadirQEnhancements.debounce(loadAbsentStudents, 300);
                    manualSearch.addEventListener('input', debouncedManualSearch);
                    // Remove onkeyup attribute jika ada
                    manualSearch.removeAttribute('onkeyup');
                }
            });

        </script>
</body>

</html>